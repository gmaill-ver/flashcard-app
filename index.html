<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AnkiMaster - フラッシュカード学習</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f0f0f0;min-height:100vh;color:#333}
    .page{display:none;max-width:600px;margin:0 auto;padding:0 16px 40px;animation:fadeIn .25s ease}
    .page.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .login-page{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center}
    .login-logo{font-size:3rem;margin-bottom:8px}.login-title{font-size:1.6rem;font-weight:700;margin-bottom:4px}.login-sub{font-size:.9rem;color:#888;margin-bottom:40px}
    .login-btn{display:flex;align-items:center;gap:12px;padding:14px 32px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:1rem;cursor:pointer;transition:all .2s;width:280px;justify-content:center;margin-bottom:12px}
    .login-btn:hover{background:#f5f5f5;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .login-btn-google{border-color:#4285f4;font-weight:500}.login-btn-guest{border-color:#ccc;color:#666}.login-google-icon{width:20px;height:20px}

    .loading-overlay{position:fixed;inset:0;background:#f0f0f0;z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
    .loading-overlay.hidden{display:none}
    .spinner{width:36px;height:36px;border:3px solid #ddd;border-top-color:#2196f3;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .app-header{background:#fff;border-bottom:1px solid #ddd;padding:12px 16px;margin-bottom:0;display:flex;align-items:center;gap:10px}
    .app-header h1{font-size:1.05rem;font-weight:700;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .header-back{background:none;border:none;font-size:1.4rem;cursor:pointer;color:#2196f3;padding:4px 8px;display:none}
    .header-back.visible{display:block}
    .header-actions{display:flex;gap:4px;align-items:center}
    .header-icon-btn{background:none;border:none;font-size:1.1rem;cursor:pointer;padding:6px 8px;border-radius:6px;color:#555}
    .header-icon-btn:hover{background:#eee}
    .header-user{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:#f5f5f5;cursor:pointer;overflow:hidden}
    .header-user:hover{background:#eee}

    /* ホームタブ */
    .home-tabs{display:flex;background:#fff;border-bottom:1px solid #ddd;margin:0 -16px 16px;padding:0 16px}
    .home-tab{flex:1;padding:12px;border:none;background:none;font-size:.9rem;cursor:pointer;color:#888;font-weight:500;border-bottom:2px solid transparent;transition:all .2s}
    .home-tab.active{color:#2196f3;border-bottom-color:#2196f3}
    .home-section{display:none}.home-section.active{display:block}

    .deck-list{display:flex;flex-direction:column;gap:4px}
    .deck-card{background:#fff;border-radius:12px;padding:14px 18px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:box-shadow .2s,transform .15s;border:1px solid #e0e0e0}
    .deck-card:hover{box-shadow:0 2px 12px rgba(0,0,0,.08);transform:translateY(-1px)}
    .deck-card:active{transform:scale(.99)}
    .deck-card-name{font-size:1rem;font-weight:600}
    .deck-count{font-size:.78rem;color:#888}
    .deck-chevron{font-size:.7rem;color:#999;flex-shrink:0}
    .deck-manage-btn{margin-left:auto;background:none;border:none;cursor:pointer;font-size:1rem;padding:4px 8px;border-radius:6px;color:#999;flex-shrink:0}
    .deck-manage-btn:hover{background:#f0f0f0;color:#555}
    .badge-public{font-size:.65rem;background:#e8f5e9;color:#2e7d32;padding:1px 8px;border-radius:10px;font-weight:400}

    .subdeck-card{margin-left:24px;background:#fafafa;border-radius:10px;padding:10px 16px;cursor:pointer;border:1px solid #eee;transition:all .2s;font-size:.9rem;font-weight:500}
    .subdeck-card:hover{background:#f0f0f0}
    .subdeck-study-all{color:#2196f3}

    .add-deck-row{display:flex;gap:8px}
    .add-deck-row input{flex:1;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:.95rem;background:#fafafa}
    .add-deck-row input:focus{outline:none;border-color:#2196f3}

    .btn{padding:10px 20px;border:none;border-radius:8px;font-size:.95rem;cursor:pointer;transition:all .2s;font-weight:500}
    .btn:active{transform:scale(.97)}
    .btn-blue{background:#2196f3;color:#fff}.btn-blue:hover{background:#1976d2}
    .btn-sm{padding:6px 14px;font-size:.8rem}
    .btn-gray{background:#e0e0e0;color:#555}
    .btn-red{background:#ef5350;color:#fff}.btn-red:hover{background:#d32f2f}
    .btn-green{background:#4caf50;color:#fff}.btn-green:hover{background:#388e3c}
    .btn-outline{background:none;border:1px solid #ddd;color:#555}.btn-outline:hover{background:#f5f5f5}


    /* 公開デッキ */
    .pub-deck-card{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;margin-bottom:8px}
    .pub-deck-title{font-size:1rem;font-weight:600;margin-bottom:4px}
    .pub-deck-meta{font-size:.78rem;color:#888;margin-bottom:4px;display:flex;gap:10px}
    .pub-deck-desc{font-size:.82rem;color:#666;margin-bottom:10px}
    .pub-deck-actions{display:flex;gap:8px}

    /* 学習 */
    .study-deck-name{font-size:.85rem;color:#888;text-align:center;margin-bottom:8px;margin-top:16px}
    .study-progress{font-size:.85rem;color:#666;text-align:center;margin-bottom:12px}
    .study-progress-bar{height:4px;background:#e0e0e0;border-radius:2px;margin-top:6px;overflow:hidden}
    .study-progress-fill{height:100%;background:#4caf50;border-radius:2px;transition:width .3s}
    .study-filters{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
    .study-filter-btn{padding:6px 14px;border:1px solid #ddd;border-radius:20px;background:#fff;font-size:.78rem;cursor:pointer;white-space:nowrap;color:#666;transition:all .2s}
    .study-filter-btn.active{background:#333;color:#fff;border-color:#333}
    .study-filter-btn .filter-count{margin-left:4px;opacity:.7}
    .study-sort{margin-bottom:12px;display:flex;align-items:center;gap:8px}.study-sort select{padding:6px 12px;border:1px solid #ddd;border-radius:8px;font-size:.8rem;background:#fff;color:#555;cursor:pointer}
    .study-icon-btn{width:36px;height:36px;border:1px solid #ddd;border-radius:8px;background:#fff;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#555;transition:all .2s;flex-shrink:0}
    .study-icon-btn:hover{background:#f0f0f0}.study-icon-btn.active{background:#e3f2fd;border-color:#2196f3;color:#1565c0}
    #shuffle-btn{filter:grayscale(1) opacity(.45)}
    .anki-card{background:#fff;border-radius:12px;min-height:280px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;padding:32px 24px;text-align:left;font-size:1.15rem;line-height:1.8;cursor:pointer;border:1px solid #e0e0e0;position:relative;user-select:none}
    .anki-card-label{position:absolute;top:12px;left:16px;font-size:.75rem;color:#aaa;font-weight:600}
    .anki-card-subdeck{position:absolute;top:12px;right:16px;font-size:.7rem;color:#64b5f6;background:#e3f2fd;padding:2px 8px;border-radius:10px}
    .anki-card-stats{position:absolute;bottom:10px;right:12px;font-size:.9rem;letter-spacing:2px;text-align:right;max-width:80%;word-break:break-all;line-height:1.4}.mark-x{color:#e57373}.mark-o{color:#66bb6a}
    .anki-card-text{white-space:pre-wrap;word-break:break-word}
    .anki-divider{width:80%;border:none;border-top:1px solid #e0e0e0;margin:20px 0}
    .anki-answer-section{color:#1565c0}
    .anki-rating{display:flex;gap:8px;margin-top:20px}
    .anki-rating-btn{flex:1;padding:14px 8px;border:none;border-radius:8px;font-size:.9rem;cursor:pointer;font-weight:600;transition:all .15s}
    .anki-rating-btn:active{transform:scale(.96)}
    .anki-rating-btn.incorrect{background:#ffcdd2;color:#c62828}.anki-rating-btn.incorrect:hover{background:#ef9a9a}
    .anki-rating-btn.correct{background:#c8e6c9;color:#2e7d32}.anki-rating-btn.correct:hover{background:#a5d6a7}
    .anki-rating-btn.understood{background:#bbdefb;color:#1565c0}.anki-rating-btn.understood:hover{background:#90caf9}
    /* 管理 */
    .publish-section{background:#fff;border-radius:12px;padding:16px 20px;border:1px solid #e0e0e0;margin-bottom:12px}
    .publish-section h3{font-size:.9rem;color:#555;margin-bottom:10px}
    .publish-status{font-size:.85rem;color:#888;margin-bottom:10px}
    .publish-status.published{color:#2e7d32}
    .manage-subdeck-section{background:#fff;border-radius:12px;padding:16px 20px;border:1px solid #e0e0e0;margin-bottom:12px}
    .manage-subdeck-section h3{font-size:.9rem;color:#555;margin-bottom:10px}
    .subdeck-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
    .subdeck-chip{background:#e3f2fd;color:#1565c0;padding:4px 12px;border-radius:16px;font-size:.8rem;display:flex;align-items:center;gap:6px}
    .subdeck-chip-rename{cursor:pointer;opacity:.5;font-size:.75rem}.subdeck-chip-rename:hover{opacity:1}
    .subdeck-chip-del{cursor:pointer;opacity:.6;font-size:.9rem}.subdeck-chip-del:hover{opacity:1}
    .manage-form{background:#fff;border-radius:12px;padding:20px;border:1px solid #e0e0e0;margin-bottom:16px}
    .manage-form h3{font-size:.95rem;margin-bottom:16px;color:#555}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;font-size:.8rem;color:#888;margin-bottom:6px;font-weight:500}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:.95rem;background:#fafafa;color:#333}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#2196f3;background:#fff}
    .form-group textarea{min-height:200px;resize:vertical;font-family:inherit;line-height:1.6}
    .card-list-section{margin-top:20px}.card-list-section h3{font-size:.95rem;color:#555;margin-bottom:12px}
    .card-item{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:12px 16px;margin-bottom:8px;display:flex;align-items:flex-start;gap:12px}
    .card-item-content{flex:1;overflow:hidden}
    .card-item-q{font-weight:600;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
    .card-item-a{font-size:.8rem;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card-item-tags{display:flex;gap:4px;margin-top:4px}
    .card-item-tag{font-size:.68rem;padding:1px 8px;border-radius:10px}
    .tag-subdeck{background:#e3f2fd;color:#1565c0}.tag-incorrect{background:#ffcdd2;color:#c62828}.tag-correct{background:#c8e6c9;color:#2e7d32}.tag-understood{background:#bbdefb;color:#1565c0}
    .card-item-actions{display:flex;gap:4px}
    .card-item-btn{border:none;background:none;cursor:pointer;font-size:.95rem;padding:4px 8px;border-radius:6px}
    .card-item-btn:hover{background:#f0f0f0}
    .empty-state{text-align:center;padding:40px 20px;color:#aaa}.empty-state-icon{font-size:3rem;margin-bottom:12px}

    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
    .stat-card{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;text-align:center}
    .stat-value{font-size:1.8rem;font-weight:700;color:#2196f3}.stat-label{font-size:.8rem;color:#999;margin-top:4px}
    .stats-chart-wrap{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;margin-bottom:20px}
    .stats-range{display:flex;gap:6px;margin-bottom:12px}
    .stats-range-btn{padding:6px 16px;border:1px solid #ddd;border-radius:20px;background:#fff;font-size:.8rem;cursor:pointer;color:#666;transition:all .2s}
    .stats-range-btn.active{background:#333;color:#fff;border-color:#333}

    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;justify-content:center;align-items:flex-end}
    .modal-overlay.active{display:flex}
    .modal{background:#fff;border-radius:16px 16px 0 0;width:100%;max-width:600px;padding:24px 20px;max-height:70vh;overflow-y:auto;animation:slideUp .25s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal h3{font-size:1rem;margin-bottom:16px}
    .modal-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #eee;font-size:.9rem}
    .modal-row:last-child{border-bottom:none}
    .modal-row input[type="number"]{width:60px;padding:6px;border:1px solid #ddd;border-radius:6px;text-align:center;font-size:.9rem}
    .modal-close{display:block;width:100%;padding:14px;margin-top:16px;background:#e0e0e0;border:none;border-radius:8px;font-size:.95rem;cursor:pointer}
    .modal-row-danger{color:#d32f2f;cursor:pointer}.modal-row-danger:hover{background:#fff5f5}

    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 24px;border-radius:8px;font-size:.85rem;z-index:200;opacity:0;transition:opacity .3s;pointer-events:none}
    .toast.show{opacity:1}

    @media(max-width:600px){.anki-card{min-height:220px;padding:24px 16px;font-size:1rem}}
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading"><div class="spinner"></div><div style="color:#888;font-size:.9rem">読み込み中...</div></div>

  <div class="page" id="page-login"><div class="login-page">
    <div class="login-logo">&#x1f4da;</div><div class="login-title">AnkiMaster</div>
    <div class="login-sub">資格試験のためのフラッシュカード学習</div>
    <button class="login-btn login-btn-google" id="google-login-btn">
      <svg class="login-google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Googleでログイン</button>
    <button class="login-btn login-btn-guest" id="guest-login-btn">&#x1f464; お試しで使う（ゲスト）</button>
  </div></div>

  <div class="app-header" id="app-header" style="display:none">
    <button class="header-back" id="back-btn">&#8592;</button>
    <h1 id="header-title">デッキ</h1>
    <div class="header-actions">
      <button class="header-icon-btn" id="stats-btn" title="統計">&#x1f4ca;</button>
      <button class="header-icon-btn" id="settings-btn" title="設定">&#x2699;</button>
      <div class="header-user" id="header-user"><img id="header-avatar" style="width:100%;height:100%;object-fit:cover;display:none"><span id="header-user-icon" style="font-size:1.1rem">&#x1f464;</span></div>
    </div>
  </div>

  <!-- ホーム -->
  <div class="page" id="page-home">
    <div class="home-tabs">
      <button class="home-tab active" data-tab="my" id="tab-my">マイデッキ</button>
      <button class="home-tab" data-tab="public" id="tab-public">公開デッキ</button>
    </div>
    <div class="home-section active" id="section-my">
      <div class="deck-list" id="deck-list"></div>
    </div>
    <div class="home-section" id="section-public">
      <div id="public-deck-list"></div>
      <div class="empty-state" id="public-loading" style="padding:20px"><div class="spinner" style="margin:0 auto 12px"></div>読み込み中...</div>
    </div>
  </div>

  <!-- 学習 -->
  <div class="page" id="page-study">
    <div class="study-deck-name" id="study-deck-name"></div>
    <div class="study-filters" id="study-filters"></div>
    <div class="study-sort" id="study-sort"></div>
    <div class="study-progress"><span id="study-progress-text">0 / 0</span><div class="study-progress-bar"><div class="study-progress-fill" id="study-progress-fill" style="width:0%"></div></div></div>
    <div class="anki-card" id="anki-card">
      <span class="anki-card-label" id="anki-label">問題</span>
      <span class="anki-card-subdeck" id="anki-subdeck" style="display:none"></span>
      <div class="anki-card-text" id="anki-question"></div>
      <hr class="anki-divider" id="anki-divider" style="display:none">
      <div class="anki-card-text anki-answer-section" id="anki-answer" style="display:none"></div>
      <div class="anki-card-stats" id="anki-card-stats" style="display:none"></div>
    </div>
    <div class="anki-rating" id="anki-rating" style="display:none">
      <button class="anki-rating-btn correct" data-rating="correct">◯</button>
      <button class="anki-rating-btn incorrect" data-rating="incorrect">×</button>
      <button class="anki-rating-btn understood" data-rating="understood">&#x1f44d;</button>
    </div>
  </div>

  <!-- カード管理 -->
  <div class="page" id="page-manage">
    <div class="manage-form">
      <h3 id="manage-form-title">カードを追加</h3>
      <form id="card-form">
        <div class="form-group" id="subdeck-select-group" style="display:none"><label>サブデッキ</label><select id="card-subdeck-select"><option value="">なし（直下）</option></select></div>
        <div class="form-group"><label>問題（表面）</label><textarea id="card-question" placeholder="問題を入力"></textarea></div>
        <div class="form-group"><label>答え（裏面）</label><textarea id="card-answer" placeholder="答えを入力"></textarea></div>
        <div style="display:flex;gap:8px"><button type="submit" class="btn btn-blue" style="flex:1" id="card-submit-btn">追加</button><button type="button" class="btn btn-gray" id="card-cancel-btn" style="display:none">キャンセル</button></div>
      </form>
    </div>
    <div class="card-list-section"><h3 id="manage-card-count">カード (0枚)</h3><div id="manage-subdeck-filter" style="margin-bottom:10px"></div><div id="manage-card-list"></div></div>
  </div>

  <!-- 統計 -->
  <div class="page" id="page-stats">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="s-total-reviews">0</div><div class="stat-label">総学習回数</div></div>
      <div class="stat-card"><div class="stat-value" id="s-study-days">0</div><div class="stat-label">学習日数</div></div>
    </div>
    <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="stat-card"><div class="stat-value" id="s-correct">0</div><div class="stat-label">◯</div></div>
      <div class="stat-card"><div class="stat-value" id="s-incorrect">0</div><div class="stat-label">×</div></div>
      <div class="stat-card"><div class="stat-value" id="s-understood">0</div><div class="stat-label">&#x1f44d;</div></div>
    </div>
    <div class="stats-chart-wrap">
      <div class="stats-range">
        <button class="stats-range-btn active" data-range="day">日</button>
        <button class="stats-range-btn" data-range="week">週</button>
        <button class="stats-range-btn" data-range="month">月</button>
      </div>
      <canvas id="stats-chart"></canvas>
      <div style="margin-top:12px"><select id="stats-deck-filter" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:.85rem;background:#fff;color:#555"></select></div>
    </div>
  </div>

  <div class="modal-overlay" id="settings-modal"><div class="modal">
    <h3>&#x2699; 設定</h3>
    <div class="modal-row" id="add-deck-modal-row">&#x2795; デッキを追加</div>
    <div id="add-deck-modal-section" style="display:none;padding:8px 0"><div style="display:flex;gap:8px"><input type="text" id="settings-deck-input" placeholder="デッキ名を入力" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:.9rem"><button class="btn btn-blue btn-sm" id="settings-add-deck-btn">追加</button></div></div>
    <div class="modal-row" id="deck-ops-row">&#x1f4c1; デッキ操作</div>
    <div id="deck-ops-section" style="display:none;padding:8px 0"><select id="deck-ops-select" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:.9rem;margin-bottom:8px"></select><div style="display:flex;gap:8px"><button class="btn btn-blue btn-sm" id="deck-edit-btn" style="flex:1">編集</button><button class="btn btn-gray btn-sm" id="deck-rename-btn" style="flex:1">名称変更</button><button class="btn btn-red btn-sm" id="deck-delete-btn" style="flex:1">削除</button></div></div>
    <div class="modal-row" id="csv-import-row">&#x1f4e5; CSVインポート</div>
    <div id="csv-import-section" style="display:none;padding:8px 0"><select id="csv-import-deck" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:.9rem;margin-bottom:8px"></select><label class="btn btn-outline btn-sm" style="display:block;text-align:center;cursor:pointer">ファイルを選択<input type="file" id="csv-file" accept=".csv" style="display:none"></label><div style="font-size:.72rem;color:#999;margin-top:6px">形式: 問題,回答（1行1問、カンマ区切り）</div></div>
    <div class="modal-row" id="autoplay-settings-row">&#x25b6;&#xfe0e; 再生</div>
    <div id="autoplay-settings-section" style="display:none;padding:4px 0">
      <div class="modal-row"><span>問題の表示時間（秒）</span><input type="number" id="cfg-q-delay" value="3" min="1" max="30"></div>
      <div class="modal-row"><span>答えの表示時間（秒）</span><input type="number" id="cfg-a-delay" value="3" min="1" max="30"></div>
    </div>
    <div class="modal-row" id="howto-row">&#x1f4d6; 使い方</div>
    <div id="howto-section" style="display:none;padding:12px 0;font-size:.82rem;color:#555;line-height:1.9">
      <b>1. デッキを作成</b><br>設定 → 「デッキを追加」から科目名を入力して追加します。<br><br>
      <b>2. カードを登録</b><br>ホーム画面のデッキ右側の &#x1f4cb; アイコンから、問題と回答を入力して追加していきます。サブデッキ（小分類）を追加したい場合は、カード管理画面の &#x2699; アイコンから追加できます。CSVで一括インポートも可能です。<br><br>
      <b>3. 学習開始</b><br>ホーム画面でデッキをタップして学習スタート。カードをタップすると答えが表示されます。もう一度タップで問題に戻ります。<br><br>
      <b>4. 学習サイクル</b><br>最初は「全」カテゴリで全問表示されます。<br>
      &#x2022; わからなかった → <b>×</b> をタップ<br>
      &#x2022; 正解できた → <b>◯</b> をタップ<br>
      &#x2022; 完全に理解した → <b>&#x1f44d;</b> をタップ<br><br>
      ×のカードを重点的に繰り返し、少しずつ◯ → &#x1f44d; へ移動させていくのが学習のサイクルです。<br><br>
      <b>5. 統計でモチベーション維持</b><br>&#x1f4ca; アイコンで学習の進捗をグラフで確認できます。毎日コツコツ続けて、学習日数を積み上げていきましょう！
    </div>
    <div class="modal-row modal-row-danger" id="reset-group-row">&#x1f504; リセット</div>
    <div id="reset-group-section" style="display:none;padding:4px 0">
      <div class="modal-row modal-row-danger" id="reset-card-stats-row">カード統計をリセット</div>
      <div class="modal-row modal-row-danger" id="reset-stats-btn">学習統計をリセット</div>
    </div>
    <div class="modal-row modal-row-danger" id="logout-row">&#x1f6aa; ログアウト</div>
    <button class="modal-close" id="settings-close">閉じる</button>
  </div></div>
  <div class="modal-overlay" id="manage-settings-modal"><div class="modal">
    <h3>&#x2699; デッキ設定</h3>
    <div style="margin-bottom:16px">
      <div style="font-size:.9rem;color:#555;margin-bottom:10px;font-weight:600">&#x1f4c2; サブデッキ</div>
      <div class="subdeck-chips" id="subdeck-chips"></div>
      <div class="add-deck-row"><input type="text" id="new-subdeck-input" placeholder="サブデッキ名"><button class="btn btn-blue btn-sm" id="add-subdeck-btn">追加</button></div>
    </div>
    <div id="publish-section">
      <div style="font-size:.9rem;color:#555;margin-bottom:10px;font-weight:600">&#x1f4e4; 公開設定</div>
      <div class="publish-status" id="publish-status">このデッキは公開されていません</div>
      <div id="publish-desc-group" class="form-group" style="margin-bottom:10px">
        <label>説明（任意）</label>
        <input type="text" id="publish-desc" placeholder="デッキの説明を入力">
      </div>
      <div style="display:flex;gap:8px" id="publish-buttons">
        <button class="btn btn-green btn-sm" id="publish-btn">公開する</button>
      </div>
    </div>
    <button class="modal-close" id="manage-settings-close">閉じる</button>
  </div></div>
  <div class="toast" id="toast"></div>

<script>
/* ========== Firebase ========== */
firebase.initializeApp({apiKey:"AIzaSyCFliHkmMAxap7386JJZb81o3dbI5uJFGU",authDomain:"ankimaster-395d5.firebaseapp.com",projectId:"ankimaster-395d5",storageBucket:"ankimaster-395d5.firebasestorage.app",messagingSenderId:"679225068510",appId:"1:679225068510:web:8acae35eb5ee7537d26b4f",measurementId:"G-PLHLN3NH45"});
const auth=firebase.auth(),db=firebase.firestore();
db.enablePersistence().catch(()=>{});

/* ========== State ========== */
let currentUser=null,isGuest=false;
let cards=[],decks=[],stats={reviews:0,incorrect:0,correct:0,understood:0};
let currentDeck=null,currentSubdeck=null,studyCards=[],studyIndex=0,answerShown=false,studyFilter='all';
let isPlaying=false,playTimer=null,editingId=null,studySort=null;
let isPublicStudy=false,activeHomeTab='my',currentPage='home',expandedDecks=new Set(),manageSubdeckFilter='';
let dailyStats={},statsChart=null,statsRange='day',statsFilterDeck='';

/* ========== LS ========== */
const LS={load(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}},save(k,v){localStorage.setItem(k,JSON.stringify(v))}};

/* ========== Data ========== */
function userDoc(){return db.collection('users').doc(currentUser.uid)}
function cardsCol(){return userDoc().collection('cards')}
function migrateDecks(r){if(!r||!r.length)return[{name:'デフォルト',subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}}];if(typeof r[0]==='string')return r.map(n=>({name:n,subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}}));return r.map(d=>({name:d.name,subdecks:d.subdecks||[],publishedId:d.publishedId||null,cardCount:d.cardCount!=null?d.cardCount:0,ratings:d.ratings||{incorrect:0,correct:0,understood:0}}))}
function migrateStats(r){const s=r||{};return{reviews:s.reviews||0,incorrect:s.incorrect||s.hard||0,correct:s.correct||s.good||0,understood:s.understood||s.easy||0}}

async function loadData(){
  if(isGuest){decks=migrateDecks(LS.load('fc_decks',null));cards=LS.load('fc_cards',[]);stats=migrateStats(LS.load('fc_stats',null));dailyStats=LS.load('fc_daily',{});if(!cards.length)seedSample();syncAllDeckMeta();return}
  try{
    const doc=await userDoc().get();let needsMeta=false;
    if(doc.exists){const d=doc.data(),raw=d.decks;decks=migrateDecks(raw);stats=migrateStats(d.stats);dailyStats=d.dailyStats||{};needsMeta=raw&&raw.length>0&&raw[0].cardCount==null}
    else{decks=[{name:'デフォルト',subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}}];stats={reviews:0,incorrect:0,correct:0,understood:0};await userDoc().set({decks,stats});await seedFS();syncAllDeckMeta();await saveDecks()}
    if(needsMeta){const snap=await cardsCol().get();const all=snap.docs.map(d=>({id:d.id,...d.data()}));for(const dk of decks){const dc=all.filter(c=>c.deck===dk.name);dk.cardCount=dc.length;dk.ratings={incorrect:dc.filter(c=>c.lastRating==='incorrect').length,correct:dc.filter(c=>c.lastRating==='correct').length,understood:dc.filter(c=>c.lastRating==='understood').length}};await saveDecks()}
    cards=[];
  }catch(e){console.error(e);showToast('読み込み失敗')}
}
async function saveDecks(){if(isGuest){LS.save('fc_decks',decks);return}try{await userDoc().update({decks})}catch(e){console.error(e)}}
async function saveStats(){if(isGuest){LS.save('fc_stats',stats);LS.save('fc_daily',dailyStats);return}try{await userDoc().update({stats,dailyStats})}catch(e){console.error(e)}}
async function addCard(c,skipMeta){if(isGuest){c.id=Date.now().toString()+Math.random();cards.push(c);LS.save('fc_cards',cards)}else{try{const r=await cardsCol().add(c);cards.push({id:r.id,...c})}catch(e){console.error(e);showToast('保存失敗');return}}if(!skipMeta){const dk=getDeck(c.deck);if(dk){dk.cardCount=(dk.cardCount||0)+1;await saveDecks()}}}
async function updateCard(id,data){const i=cards.findIndex(c=>c.id===id);if(i===-1)return;cards[i]={...cards[i],...data};if(isGuest){LS.save('fc_cards',cards);return}try{await cardsCol().doc(id).update(data)}catch(e){console.error(e)}}
async function removeCard(id){const old=cards.find(c=>c.id===id);cards=cards.filter(c=>c.id!==id);if(isGuest){LS.save('fc_cards',cards)}else{try{await cardsCol().doc(id).delete()}catch(e){console.error(e)}}if(old){const dk=getDeck(old.deck);if(dk){dk.cardCount=Math.max(0,(dk.cardCount||0)-1);if(old.lastRating&&dk.ratings)dk.ratings[old.lastRating]=Math.max(0,(dk.ratings[old.lastRating]||0)-1);await saveDecks()}}}

function todayStr(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function trackDaily(r,dk){const t=todayStr();if(!dailyStats[t])dailyStats[t]={reviews:0,incorrect:0,correct:0,understood:0,decks:{}};dailyStats[t].reviews++;dailyStats[t][r]++;if(dk){if(!dailyStats[t].decks)dailyStats[t].decks={};if(!dailyStats[t].decks[dk])dailyStats[t].decks[dk]={reviews:0,incorrect:0,correct:0,understood:0};dailyStats[t].decks[dk].reviews++;dailyStats[t].decks[dk][r]++}}
function syncAllDeckMeta(){for(const dk of decks){const dc=cards.filter(c=>c.deck===dk.name);dk.cardCount=dc.length;dk.ratings={incorrect:dc.filter(c=>c.lastRating==='incorrect').length,correct:dc.filter(c=>c.lastRating==='correct').length,understood:dc.filter(c=>c.lastRating==='understood').length}}}
function syncCurrentDeckMeta(){const dk=getDeck(currentDeck);if(!dk)return;const dc=cards.filter(c=>c.deck===currentDeck);dk.cardCount=dc.length;dk.ratings={incorrect:dc.filter(c=>c.lastRating==='incorrect').length,correct:dc.filter(c=>c.lastRating==='correct').length,understood:dc.filter(c=>c.lastRating==='understood').length}}
async function loadDeckCards(name){if(isGuest)return;try{const snap=await cardsCol().where('deck','==',name).get();cards=snap.docs.map(d=>({id:d.id,...d.data()}))}catch(e){console.error(e);showToast('カード読み込み失敗')}}

function seedSample(){cards=[{id:'1',question:'民法第1条の3つの基本原則は？',answer:'①公共の福祉適合の原則\n②信義誠実の原則\n③権利濫用禁止の原則',deck:'デフォルト',subdeck:'',lastRating:null,created:new Date().toISOString()},{id:'2',question:'憲法第9条の内容は？',answer:'第1項：戦争の放棄\n第2項：戦力の不保持、交戦権の否認',deck:'デフォルト',subdeck:'',lastRating:null,created:new Date().toISOString()},{id:'3',question:'尊属殺重罰規定違憲判決のポイントは？',answer:'刑法200条は法の下の平等（憲法14条1項）に違反し無効。',deck:'デフォルト',subdeck:'',lastRating:null,created:new Date().toISOString()}];LS.save('fc_cards',cards)}
async function seedFS(){const ss=[{question:'民法第1条の3つの基本原則は？',answer:'①公共の福祉適合の原則\n②信義誠実の原則\n③権利濫用禁止の原則',deck:'デフォルト',subdeck:'',lastRating:null,created:new Date().toISOString()},{question:'憲法第9条の内容は？',answer:'第1項：戦争の放棄\n第2項：戦力の不保持、交戦権の否認',deck:'デフォルト',subdeck:'',lastRating:null,created:new Date().toISOString()}];for(const s of ss){const r=await cardsCol().add(s);cards.push({id:r.id,...s})}}

/* ========== Auth ========== */
document.getElementById('google-login-btn').addEventListener('click',async()=>{try{await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())}catch(e){if(e.code!=='auth/popup-closed-by-user')showToast('ログイン失敗')}});
document.getElementById('guest-login-btn').addEventListener('click',()=>{isGuest=true;currentUser=null;initApp()});
document.getElementById('logout-row').addEventListener('click',async()=>{document.getElementById('settings-modal').classList.remove('active');if(isGuest){isGuest=false;showPage('login');document.getElementById('app-header').style.display='none';return}await auth.signOut()});
auth.onAuthStateChanged(async u=>{if(u&&!isGuest){currentUser=u;isGuest=false;await initApp()}else if(!isGuest){currentUser=null;document.getElementById('loading').classList.add('hidden');document.getElementById('app-header').style.display='none';showPage('login')}});
async function initApp(){document.getElementById('loading').classList.remove('hidden');await loadData();document.getElementById('loading').classList.add('hidden');document.getElementById('app-header').style.display='flex';if(!isGuest&&currentUser?.photoURL){document.getElementById('header-avatar').src=currentUser.photoURL;document.getElementById('header-avatar').style.display='block';document.getElementById('header-user-icon').style.display='none'}else{document.getElementById('header-avatar').style.display='none';document.getElementById('header-user-icon').style.display='block'}navigateTo('home')}

/* ========== Nav ========== */
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+id).classList.add('active')}
async function navigateTo(page,data){
  stopAutoPlay();isPublicStudy=false;currentPage=page;
  const back=document.getElementById('back-btn'),title=document.getElementById('header-title');
  switch(page){
    case'home':showPage('home');back.classList.remove('visible');title.textContent='ウルトラAnki';renderDeckList();setHomeTab(activeHomeTab);break;
    case'study':showPage('study');back.classList.add('visible');currentDeck=data.deck;currentSubdeck=data.subdeck||null;title.textContent=currentSubdeck?`${currentDeck} > ${currentSubdeck}`:currentDeck;studyFilter=LS.load('fc_studyFilter','all');studySort=LS.load('fc_studySort',null);if(!isGuest){document.getElementById('loading').classList.remove('hidden');await loadDeckCards(currentDeck);document.getElementById('loading').classList.add('hidden')}startStudy();break;
    case'public-study':showPage('study');back.classList.add('visible');isPublicStudy=true;title.textContent=data.title;studyCards=data.cards;studyIndex=0;answerShown=false;document.getElementById('study-filters').innerHTML='';renderStudyCard();break;
    case'manage':showPage('manage');back.classList.add('visible');currentDeck=data;title.textContent=data+' - 管理';manageSubdeckFilter='';if(!isGuest){document.getElementById('loading').classList.remove('hidden');await loadDeckCards(currentDeck);document.getElementById('loading').classList.add('hidden')}resetForm();renderManageSubdecks();renderManageList();break;
    case'stats':showPage('stats');back.classList.add('visible');title.textContent='統計';renderStats();break;
  }
}
document.getElementById('back-btn').addEventListener('click',()=>navigateTo('home'));
document.getElementById('stats-btn').addEventListener('click',()=>navigateTo('stats'));

/* ========== Home Tabs ========== */
function setHomeTab(tab){
  activeHomeTab=tab;
  document.querySelectorAll('.home-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.querySelectorAll('.home-section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab==='my'?'section-my':'section-public').classList.add('active');
  if(tab==='public')loadPublicDecks();
}
document.querySelectorAll('.home-tab').forEach(t=>t.addEventListener('click',()=>setHomeTab(t.dataset.tab)));

/* ========== Helpers ========== */
function getDeck(n){return decks.find(d=>d.name===n)}
function deckCards(n){return cards.filter(c=>c.deck===n)}
function subdeckCards(n,s){return cards.filter(c=>c.deck===n&&c.subdeck===s)}
function countR(a,r){return a.filter(c=>c.lastRating===r).length}
function countU(a){return a.filter(c=>!c.lastRating).length}

/* ========== Home: My Decks ========== */
function renderDeckList(){
  const el=document.getElementById('deck-list');let html='';
  for(const d of decks){
    const total=d.cardCount||0,hasSD=d.subdecks&&d.subdecks.length>0,exp=expandedDecks.has(d.name);
    html+=`<div class="deck-card" data-deck="${esc(d.name)}">${hasSD?`<span class="deck-chevron">${exp?'▼':'▶'}</span>`:''}<span class="deck-card-name">${esc(d.name)}</span>${d.publishedId?'<span class="badge-public">公開中</span>':''}<span class="deck-count">${total}枚</span><button class="deck-manage-btn" data-act="manage" data-deck="${esc(d.name)}" title="カード管理">&#x1f4cb;</button></div>`;
    if(hasSD&&exp){for(const sd of d.subdecks){html+=`<div class="subdeck-card" data-deck="${esc(d.name)}" data-subdeck="${esc(sd)}">${esc(sd)}</div>`}html+=`<div class="subdeck-card subdeck-study-all" data-deck="${esc(d.name)}" data-subdeck="">全体を学習</div>`}
  }
  el.innerHTML=html;
  el.querySelectorAll('.deck-card').forEach(c=>{c.addEventListener('click',e=>{if(e.target.closest('[data-act="manage"]')){e.stopPropagation();navigateTo('manage',c.dataset.deck);return}const dk=getDeck(c.dataset.deck);if(dk&&dk.subdecks&&dk.subdecks.length>0){if(expandedDecks.has(dk.name))expandedDecks.delete(dk.name);else expandedDecks.add(dk.name);renderDeckList()}else{navigateTo('study',{deck:c.dataset.deck})}})});
  el.querySelectorAll('.subdeck-card').forEach(c=>{c.addEventListener('click',()=>{const sd=c.dataset.subdeck;if(sd)navigateTo('study',{deck:c.dataset.deck,subdeck:sd});else navigateTo('study',{deck:c.dataset.deck})})});
}

async function deleteDeckAction(name){
  if(!confirm(`「${name}」を削除？\nカードはデフォルトに移動。`))return;
  const delDeck=getDeck(name);const defDeck=getDeck('デフォルト');
  if(isGuest){for(const c of cards){if(c.deck===name){c.deck='デフォルト';c.subdeck=''}}LS.save('fc_cards',cards)}
  else{const snap=await cardsCol().where('deck','==',name).get();const docs=snap.docs;for(let i=0;i<docs.length;i+=400){const batch=db.batch();docs.slice(i,i+400).forEach(d=>batch.update(d.ref,{deck:'デフォルト',subdeck:''}));await batch.commit()}}
  if(defDeck&&delDeck){defDeck.cardCount=(defDeck.cardCount||0)+(delDeck.cardCount||0);defDeck.ratings={incorrect:(defDeck.ratings?.incorrect||0)+(delDeck.ratings?.incorrect||0),correct:(defDeck.ratings?.correct||0)+(delDeck.ratings?.correct||0),understood:(defDeck.ratings?.understood||0)+(delDeck.ratings?.understood||0)}}
  decks=decks.filter(d=>d.name!==name);await saveDecks();renderDeckList();
}

async function renameDeckAction(oldName){
  const newName=prompt('新しいデッキ名を入力:',oldName);
  if(!newName||newName.trim()===''||newName.trim()===oldName)return;
  const nn=newName.trim();
  if(getDeck(nn)){showToast('同じ名前のデッキがあります');return}
  const deck=getDeck(oldName);if(!deck)return;
  deck.name=nn;
  if(isGuest){for(const c of cards){if(c.deck===oldName)c.deck=nn}LS.save('fc_cards',cards)}
  else{const snap=await cardsCol().where('deck','==',oldName).get();const docs=snap.docs;for(let i=0;i<docs.length;i+=400){const batch=db.batch();docs.slice(i,i+400).forEach(d=>batch.update(d.ref,{deck:nn}));await batch.commit()}}
  await saveDecks();renderDeckList();showToast(`「${nn}」に変更しました`);
}

/* ========== Home: Public Decks ========== */
async function loadPublicDecks(){
  const el=document.getElementById('public-deck-list'),ld=document.getElementById('public-loading');
  ld.style.display='block';el.innerHTML='';
  try{
    const snap=await db.collection('publicDecks').orderBy('updatedAt','desc').get();
    ld.style.display='none';
    if(snap.empty){el.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#x1f4da;</div><p>公開デッキはまだありません</p></div>';return}
    el.innerHTML=snap.docs.map(doc=>{const d=doc.data();return`<div class="pub-deck-card" data-id="${doc.id}"><div class="pub-deck-title">${esc(d.title)}</div><div class="pub-deck-meta"><span>${d.cardCount||0}枚</span><span>by ${esc(d.authorName||'匿名')}</span></div>${d.description?`<div class="pub-deck-desc">${esc(d.description)}</div>`:''}<div class="pub-deck-actions"><button class="btn btn-blue btn-sm" data-act="study" data-id="${doc.id}">学習する</button>${(!isGuest&&currentUser)?`<button class="btn btn-outline btn-sm" data-act="copy" data-id="${doc.id}">コピーする</button>`:''}</div></div>`}).join('');
    el.querySelectorAll('[data-act="study"]').forEach(b=>b.addEventListener('click',()=>studyPublicDeck(b.dataset.id)));
    el.querySelectorAll('[data-act="copy"]').forEach(b=>b.addEventListener('click',()=>copyPublicDeck(b.dataset.id)));
  }catch(e){ld.style.display='none';console.error(e);el.innerHTML='<div class="empty-state"><p>読み込みに失敗しました</p></div>'}
}

async function studyPublicDeck(id){
  document.getElementById('loading').classList.remove('hidden');
  try{
    const doc=await db.collection('publicDecks').doc(id).get();
    const snap=await db.collection('publicDecks').doc(id).collection('cards').orderBy('order').get();
    const pubCards=snap.docs.map((d,i)=>({question:d.data().question,answer:d.data().answer,subdeck:'',order:i}));
    document.getElementById('loading').classList.add('hidden');
    if(!pubCards.length){showToast('カードがありません');return}
    activeHomeTab='public';
    navigateTo('public-study',{title:doc.data().title,cards:pubCards});
  }catch(e){document.getElementById('loading').classList.add('hidden');console.error(e);showToast('読み込み失敗')}
}

async function copyPublicDeck(id){
  if(isGuest||!currentUser){showToast('コピーするにはログインしてください');return}
  if(!confirm('このデッキをマイデッキにコピーしますか？'))return;
  document.getElementById('loading').classList.remove('hidden');
  try{
    const doc=await db.collection('publicDecks').doc(id).get();
    const d=doc.data();
    const deckName=d.title;
    let finalName=deckName;let cnt=1;while(getDeck(finalName)){finalName=`${deckName} (${cnt++})`}
    decks.push({name:finalName,subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}});
    const snap=await db.collection('publicDecks').doc(id).collection('cards').orderBy('order').get();
    for(const c of snap.docs){const cd=c.data();await addCard({question:cd.question,answer:cd.answer,deck:finalName,subdeck:'',lastRating:null,created:new Date().toISOString()},true)}
    const newDeck=getDeck(finalName);if(newDeck){newDeck.cardCount=snap.docs.length;newDeck.ratings={incorrect:0,correct:0,understood:0}}
    cards=[];await saveDecks();
    document.getElementById('loading').classList.add('hidden');
    showToast(`「${finalName}」にコピーしました`);setHomeTab('my');renderDeckList();
  }catch(e){document.getElementById('loading').classList.add('hidden');console.error(e);showToast('コピー失敗')}
}

/* ========== Study ========== */
function getStudyPool(){
  let pool;if(currentSubdeck)pool=subdeckCards(currentDeck,currentSubdeck);else pool=deckCards(currentDeck);
  if(studyFilter!=='all'){if(studyFilter==='unrated')pool=pool.filter(c=>!c.lastRating);else pool=pool.filter(c=>c.lastRating===studyFilter)}
  if(studySort==='shuffle'){pool=[...pool];for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]]}}else if(studySort){const[field,dir]=studySort.split('-');const key=field==='incorrect'?'incorrectCount':'correctCount';pool=[...pool].sort((a,b)=>dir==='desc'?(b[key]||0)-(a[key]||0):(a[key]||0)-(b[key]||0))}
  return pool;
}
function startStudy(){renderStudyFilters();studyCards=getStudyPool();studyIndex=0;answerShown=false;renderStudyCard()}
function renderStudyFilters(){
  const sortEl=document.getElementById('study-sort');
  if(isPublicStudy){document.getElementById('study-filters').innerHTML='';sortEl.innerHTML='';return}
  const pool=currentSubdeck?subdeckCards(currentDeck,currentSubdeck):deckCards(currentDeck);
  const fs=[{key:'all',label:'全',count:pool.length},{key:'unrated',label:'未',count:countU(pool)},{key:'incorrect',label:'×',count:countR(pool,'incorrect')},{key:'correct',label:'◯',count:countR(pool,'correct')},{key:'understood',label:'&#x1f44d;',count:countR(pool,'understood')}];
  document.getElementById('study-filters').innerHTML=fs.map(f=>`<button class="study-filter-btn ${studyFilter===f.key?'active':''}" data-filter="${f.key}">${f.label}<span class="filter-count">${f.count}</span></button>`).join('');
  document.querySelectorAll('.study-filter-btn').forEach(b=>{b.addEventListener('click',()=>{studyFilter=b.dataset.filter;LS.save('fc_studyFilter',studyFilter);studyCards=getStudyPool();studyIndex=0;answerShown=false;renderStudyFilters();renderStudyCard()})});
  sortEl.innerHTML='<select id="study-sort-select"><option value="">並び順</option><option value="incorrect-desc">× 多い順</option><option value="incorrect-asc">× 少ない順</option><option value="correct-desc">◯ 多い順</option><option value="correct-asc">◯ 少ない順</option><option value="shuffle">シャッフル</option></select><button class="study-icon-btn" id="shuffle-btn" title="シャッフル">&#x1f500;</button><button class="study-icon-btn" id="autoplay-btn" title="自動再生">'+(isPlaying?'&#x25a0;':'&#x25b6;&#xfe0e;')+'</button>';
  document.getElementById('study-sort-select').value=studySort||'';
  document.getElementById('study-sort-select').addEventListener('change',e=>{studySort=e.target.value||null;LS.save('fc_studySort',studySort);studyCards=getStudyPool();studyIndex=0;answerShown=false;renderStudyCard()});
}
function renderStudyCard(){
  const qE=document.getElementById('anki-question'),aE=document.getElementById('anki-answer'),dv=document.getElementById('anki-divider'),rt=document.getElementById('anki-rating'),lb=document.getElementById('anki-label'),sd=document.getElementById('anki-subdeck'),cs=document.getElementById('anki-card-stats');
  document.getElementById('study-deck-name').textContent=isPublicStudy?'':currentSubdeck?`${currentDeck} > ${currentSubdeck}`:currentDeck;
  if(!studyCards.length){qE.textContent='カードがありません';aE.style.display='none';dv.style.display='none';rt.style.display='none';sd.style.display='none';cs.style.display='none';document.getElementById('study-progress-text').textContent='0 / 0';document.getElementById('study-progress-fill').style.width='0%';lb.textContent='';return}
  const card=studyCards[studyIndex];
  document.getElementById('study-progress-text').textContent=`${studyIndex+1} / ${studyCards.length}`;
  document.getElementById('study-progress-fill').style.width=`${((studyIndex+1)/studyCards.length)*100}%`;
  qE.textContent=card.question;aE.textContent=card.answer;
  if(card.subdeck){sd.textContent=card.subdeck;sd.style.display='block'}else sd.style.display='none';
  const xc=card.incorrectCount||0,oc=card.correctCount||0;if(xc||oc){let m='';for(let i=0;i<xc;i++)m+='<span class="mark-x">×</span>';for(let i=0;i<oc;i++)m+='<span class="mark-o">◯</span>';cs.innerHTML=m;cs.style.display='block'}else{cs.style.display='none'}
  rt.style.display='flex';
  if(answerShown){lb.textContent='問題 + 答え';aE.style.display='block';dv.style.display='block'}
  else{lb.textContent='問題';aE.style.display='none';dv.style.display='none'}
}

document.getElementById('anki-card').addEventListener('click',()=>{if(studyCards.length>0){answerShown=!answerShown;renderStudyCard()}});

document.querySelectorAll('.anki-rating-btn').forEach(b=>{b.addEventListener('click',async()=>{
  const r=b.dataset.rating;
  if(isPublicStudy){studyIndex=(studyIndex+1)%studyCards.length;answerShown=false;renderStudyCard();return}
  const card=studyCards[studyIndex];const oldRating=card.lastRating;stats.reviews++;stats[r]++;trackDaily(r,currentDeck);
  const upd={lastRating:r};if(r==='incorrect')upd.incorrectCount=(card.incorrectCount||0)+1;if(r==='correct')upd.correctCount=(card.correctCount||0)+1;
  await updateCard(card.id,upd);await saveStats();
  const dk=getDeck(currentDeck);if(dk&&dk.ratings){if(oldRating&&dk.ratings[oldRating]!=null)dk.ratings[oldRating]=Math.max(0,dk.ratings[oldRating]-1);dk.ratings[r]=(dk.ratings[r]||0)+1;saveDecks()}
  studyIndex=(studyIndex+1)%studyCards.length;answerShown=false;
  studyCards=getStudyPool();if(studyIndex>=studyCards.length)studyIndex=0;
  renderStudyFilters();renderStudyCard();
})});

document.getElementById('study-sort').addEventListener('click',e=>{const sh=e.target.closest('#shuffle-btn');const ap=e.target.closest('#autoplay-btn');if(sh){studySort='shuffle';LS.save('fc_studySort',studySort);studyCards=getStudyPool();studyIndex=0;answerShown=false;const sel=document.getElementById('study-sort-select');if(sel)sel.value='shuffle';renderStudyCard();showToast('シャッフルしました')}if(ap){if(isPlaying){stopAutoPlay()}else{if(!studyCards.length)return;isPlaying=true;ap.innerHTML='&#x25a0;';ap.classList.add('active');autoPlayNext()}}});
function stopAutoPlay(){isPlaying=false;if(playTimer)clearTimeout(playTimer);const ap=document.getElementById('autoplay-btn');if(ap){ap.innerHTML='&#x25b6;&#xfe0e;';ap.classList.remove('active')}}
function autoPlayNext(){if(!isPlaying)return;const qD=parseInt(document.getElementById('cfg-q-delay').value)*1000,aD=parseInt(document.getElementById('cfg-a-delay').value)*1000;answerShown=false;renderStudyCard();playTimer=setTimeout(()=>{if(!isPlaying)return;answerShown=true;renderStudyCard();playTimer=setTimeout(()=>{if(!isPlaying)return;if(!isPublicStudy){stats.reviews++;stats.correct++;trackDaily('correct',currentDeck);saveStats()}studyIndex=(studyIndex+1)%studyCards.length;autoPlayNext()},aD)},qD)}

/* ========== Manage ========== */
function renderPublishSection(){
  if(isGuest||!currentUser){document.getElementById('publish-section').style.display='none';return}
  document.getElementById('publish-section').style.display='block';
  const deck=getDeck(currentDeck);if(!deck)return;
  const st=document.getElementById('publish-status'),btns=document.getElementById('publish-buttons');
  if(deck.publishedId){
    st.className='publish-status published';st.textContent='&#x2705; このデッキは公開中です';
    btns.innerHTML='<button class="btn btn-green btn-sm" id="publish-update-btn">更新する</button><button class="btn btn-red btn-sm" id="unpublish-btn">非公開にする</button>';
    document.getElementById('publish-update-btn').addEventListener('click',()=>publishDeck(true));
    document.getElementById('unpublish-btn').addEventListener('click',unpublishDeck);
  }else{
    st.className='publish-status';st.textContent='このデッキは公開されていません';
    btns.innerHTML='<button class="btn btn-green btn-sm" id="publish-do-btn">公開する</button>';
    document.getElementById('publish-do-btn').addEventListener('click',()=>publishDeck(false));
  }
}

async function publishDeck(isUpdate){
  const deck=getDeck(currentDeck);if(!deck)return;
  const dc=deckCards(currentDeck);
  if(!dc.length){showToast('カードがないデッキは公開できません');return}
  const desc=document.getElementById('publish-desc').value.trim();
  const data={title:currentDeck,description:desc,authorId:currentUser.uid,authorName:currentUser.displayName||'匿名',cardCount:dc.length,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  try{
    let docId;
    if(isUpdate&&deck.publishedId){
      docId=deck.publishedId;
      await db.collection('publicDecks').doc(docId).update(data);
      // 既存カード削除
      const old=await db.collection('publicDecks').doc(docId).collection('cards').get();
      const batch1=db.batch();old.forEach(d=>batch1.delete(d.ref));await batch1.commit();
    }else{
      data.createdAt=firebase.firestore.FieldValue.serverTimestamp();
      const ref=await db.collection('publicDecks').add(data);docId=ref.id;
      deck.publishedId=docId;await saveDecks();
    }
    // カード追加（バッチ）
    let batch=db.batch(),cnt=0;
    dc.forEach((c,i)=>{const ref=db.collection('publicDecks').doc(docId).collection('cards').doc();batch.set(ref,{question:c.question,answer:c.answer,order:i});cnt++;if(cnt>=400){batch.commit();batch=db.batch();cnt=0}});
    if(cnt>0)await batch.commit();
    showToast(isUpdate?'公開デッキを更新しました':'デッキを公開しました');renderPublishSection();renderDeckList();
  }catch(e){console.error(e);showToast('公開に失敗しました')}
}

async function unpublishDeck(){
  if(!confirm('このデッキを非公開にしますか？'))return;
  const deck=getDeck(currentDeck);if(!deck||!deck.publishedId)return;
  try{
    const old=await db.collection('publicDecks').doc(deck.publishedId).collection('cards').get();
    const batch=db.batch();old.forEach(d=>batch.delete(d.ref));await batch.commit();
    await db.collection('publicDecks').doc(deck.publishedId).delete();
    deck.publishedId=null;await saveDecks();
    showToast('非公開にしました');renderPublishSection();renderDeckList();
  }catch(e){console.error(e);showToast('失敗しました')}
}

function renderManageSubdecks(){
  const deck=getDeck(currentDeck);if(!deck)return;
  const chips=document.getElementById('subdeck-chips');
  chips.innerHTML=deck.subdecks.map(sd=>`<div class="subdeck-chip">${esc(sd)}<span class="subdeck-chip-rename" data-sd="${esc(sd)}" title="名称変更">&#x270f;</span><span class="subdeck-chip-del" data-sd="${esc(sd)}" title="削除">&#x2715;</span></div>`).join('');
  chips.querySelectorAll('.subdeck-chip-rename').forEach(el=>{el.addEventListener('click',async()=>{const oldSd=el.dataset.sd;const newSd=prompt('新しいサブデッキ名:',oldSd);if(!newSd||newSd.trim()===''||newSd.trim()===oldSd)return;const nn=newSd.trim();if(deck.subdecks.includes(nn)){showToast('同じ名前のサブデッキがあります');return}const idx=deck.subdecks.indexOf(oldSd);if(idx!==-1)deck.subdecks[idx]=nn;if(isGuest){for(const c of cards){if(c.deck===currentDeck&&c.subdeck===oldSd)c.subdeck=nn}LS.save('fc_cards',cards)}else{const snap=await cardsCol().where('deck','==',currentDeck).where('subdeck','==',oldSd).get();const docs=snap.docs;for(let i=0;i<docs.length;i+=400){const batch=db.batch();docs.slice(i,i+400).forEach(d=>batch.update(d.ref,{subdeck:nn}));await batch.commit()}for(const c of cards){if(c.deck===currentDeck&&c.subdeck===oldSd)c.subdeck=nn}}await saveDecks();renderManageSubdecks();renderManageList();showToast(`「${nn}」に変更しました`)})});
  chips.querySelectorAll('.subdeck-chip-del').forEach(el=>{el.addEventListener('click',async()=>{const sd=el.dataset.sd;if(!confirm(`サブデッキ「${sd}」を削除？`))return;for(const c of cards){if(c.deck===currentDeck&&c.subdeck===sd){c.subdeck='';if(!isGuest)await cardsCol().doc(c.id).update({subdeck:''})}}if(isGuest)LS.save('fc_cards',cards);deck.subdecks=deck.subdecks.filter(s=>s!==sd);await saveDecks();renderManageSubdecks();renderManageList()})});
  const sel=document.getElementById('card-subdeck-select');
  sel.innerHTML='<option value="">なし（直下）</option>'+deck.subdecks.map(sd=>`<option value="${esc(sd)}">${esc(sd)}</option>`).join('');
  document.getElementById('subdeck-select-group').style.display=deck.subdecks.length?'block':'none';
}
document.getElementById('add-subdeck-btn').addEventListener('click',async()=>{const i=document.getElementById('new-subdeck-input'),n=i.value.trim(),dk=getDeck(currentDeck);if(n&&dk&&!dk.subdecks.includes(n)){dk.subdecks.push(n);await saveDecks();i.value='';renderManageSubdecks();renderManageList();showToast(`サブデッキ「${n}」を追加`)}});
document.getElementById('new-subdeck-input').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();document.getElementById('add-subdeck-btn').click()}});

function renderManageList(){
  const dc=deckCards(currentDeck);document.getElementById('manage-card-count').textContent=`カード (${dc.length}枚)`;
  const el=document.getElementById('manage-card-list');const fEl=document.getElementById('manage-subdeck-filter');
  const deck=getDeck(currentDeck),sds=deck?.subdecks||[];
  if(sds.length>0){fEl.innerHTML=`<select id="subdeck-filter-select" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:.85rem;background:#fff;color:#555"><option value="">全て</option>${sds.map(s=>`<option value="${esc(s)}"${manageSubdeckFilter===s?' selected':''}>${esc(s)}</option>`).join('')}</select>`;document.getElementById('subdeck-filter-select').addEventListener('change',e=>{manageSubdeckFilter=e.target.value;renderManageList()})}else{fEl.innerHTML=''}
  if(!dc.length){el.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#x1f4dd;</div><p>カードがまだありません</p></div>';return}
  const filtered=manageSubdeckFilter?dc.filter(c=>c.subdeck===manageSubdeckFilter):dc;
  el.innerHTML=filtered.map(c=>{let tags='';if(c.subdeck)tags+=`<span class="card-item-tag tag-subdeck">${esc(c.subdeck)}</span>`;if(c.incorrectCount)tags+=`<span class="card-item-tag tag-incorrect">× ${c.incorrectCount}</span>`;if(c.correctCount)tags+=`<span class="card-item-tag tag-correct">◯ ${c.correctCount}</span>`;return`<div class="card-item"><div class="card-item-content"><div class="card-item-q">${esc(c.question)}</div><div class="card-item-a">${esc(c.answer)}</div>${tags?`<div class="card-item-tags">${tags}</div>`:''}</div><div class="card-item-actions"><button class="card-item-btn" data-act="edit" data-id="${c.id}">&#x270f;</button><button class="card-item-btn" data-act="del" data-id="${c.id}">&#x1f5d1;</button></div></div>`}).join('');
  el.querySelectorAll('.card-item-btn').forEach(b=>{b.addEventListener('click',()=>{if(b.dataset.act==='edit')editCardAction(b.dataset.id);if(b.dataset.act==='del')deleteCardAction(b.dataset.id)})});
}

document.getElementById('card-form').addEventListener('submit',async e=>{e.preventDefault();const q=document.getElementById('card-question').value.trim(),a=document.getElementById('card-answer').value.trim(),sd=document.getElementById('card-subdeck-select').value;if(!q||!a)return;if(editingId){await updateCard(editingId,{question:q,answer:a,subdeck:sd});resetForm();showToast('更新しました')}else{await addCard({question:q,answer:a,deck:currentDeck,subdeck:sd,lastRating:null,created:new Date().toISOString()});showToast('追加しました')}document.getElementById('card-question').value='';document.getElementById('card-answer').value='';renderManageList()});
function editCardAction(id){const c=cards.find(x=>x.id===id);if(!c)return;editingId=id;document.getElementById('card-question').value=c.question;document.getElementById('card-answer').value=c.answer;document.getElementById('card-subdeck-select').value=c.subdeck||'';document.getElementById('manage-form-title').textContent='カードを編集';document.getElementById('card-submit-btn').textContent='更新';document.getElementById('card-cancel-btn').style.display='block';document.getElementById('card-question').scrollIntoView({behavior:'smooth'})}
async function deleteCardAction(id){if(!confirm('削除しますか？'))return;await removeCard(id);renderManageList();showToast('削除しました')}
function resetForm(){editingId=null;document.getElementById('card-question').value='';document.getElementById('card-answer').value='';document.getElementById('manage-form-title').textContent='カードを追加';document.getElementById('card-submit-btn').textContent='追加';document.getElementById('card-cancel-btn').style.display='none'}
document.getElementById('card-cancel-btn').addEventListener('click',resetForm);

/* ========== Stats ========== */
function renderStats(){document.getElementById('s-total-reviews').textContent=stats.reviews;document.getElementById('s-incorrect').textContent=stats.incorrect;document.getElementById('s-correct').textContent=stats.correct;document.getElementById('s-understood').textContent=stats.understood;document.getElementById('s-study-days').textContent=Object.keys(dailyStats).length;const sel=document.getElementById('stats-deck-filter');sel.innerHTML='<option value="">全てのデッキ</option>'+decks.map(d=>`<option value="${esc(d.name)}"${statsFilterDeck===d.name?' selected':''}>${esc(d.name)}</option>`).join('');renderStatsChart()}
function dateStr(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function getDailyReviews(k){const e=dailyStats[k];if(!e)return 0;if(statsFilterDeck)return e.decks?.[statsFilterDeck]?.reviews||0;return e.reviews||0}
function renderStatsChart(){
  const ctx=document.getElementById('stats-chart');if(!ctx)return;
  let labels=[],data=[],dayInfo=[];const now=new Date();
  if(statsRange==='day'){for(let i=13;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i);const k=dateStr(d);const dow=d.getDay();labels.push(`${d.getMonth()+1}/${d.getDate()}`);dayInfo.push(dow);data.push(getDailyReviews(k))}}
  else if(statsRange==='week'){for(let i=11;i>=0;i--){const wEnd=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i*7);const wSt=new Date(wEnd.getFullYear(),wEnd.getMonth(),wEnd.getDate()-6);let t=0;for(let j=0;j<7;j++){const d=new Date(wSt.getFullYear(),wSt.getMonth(),wSt.getDate()+j);t+=getDailyReviews(dateStr(d))}labels.push(`${wSt.getMonth()+1}/${wSt.getDate()}~`);dayInfo.push(-1);data.push(t)}}
  else{for(let i=11;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);const y=d.getFullYear(),m=d.getMonth();let t=0;for(const k of Object.keys(dailyStats)){const kd=new Date(k+'T00:00:00');if(kd.getFullYear()===y&&kd.getMonth()===m)t+=getDailyReviews(k)}labels.push(`${m+1}月`);dayInfo.push(-1);data.push(t)}}
  if(statsChart)statsChart.destroy();
  statsChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'学習数',data,borderColor:'#2196f3',backgroundColor:'rgba(33,150,243,0.1)',fill:true,tension:0.3,pointRadius:4,pointBackgroundColor:'#2196f3'}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:c=>{const dow=dayInfo[c.index];if(dow===0)return'#e53935';if(dow===6)return'#1565c0';return'#666'},font:{size:11}}},y:{beginAtZero:true,ticks:{precision:0}}}}})
}
document.querySelectorAll('.stats-range-btn').forEach(b=>{b.addEventListener('click',()=>{statsRange=b.dataset.range;document.querySelectorAll('.stats-range-btn').forEach(x=>x.classList.toggle('active',x===b));renderStatsChart()})});
document.getElementById('stats-deck-filter').addEventListener('change',e=>{statsFilterDeck=e.target.value;renderStatsChart()});
document.getElementById('reset-stats-btn').addEventListener('click',async()=>{if(!confirm('統計をリセット？'))return;stats={reviews:0,incorrect:0,correct:0,understood:0};dailyStats={};await saveStats();showToast('リセットしました');document.getElementById('settings-modal').classList.remove('active')});

/* ========== Settings ========== */
document.getElementById('settings-btn').addEventListener('click',()=>{if(currentPage==='manage'){renderManageSubdecks();renderPublishSection();document.getElementById('manage-settings-modal').classList.add('active')}else{document.getElementById('add-deck-modal-section').style.display='none';document.getElementById('deck-ops-section').style.display='none';document.getElementById('csv-import-section').style.display='none';document.getElementById('autoplay-settings-section').style.display='none';document.getElementById('howto-section').style.display='none';document.getElementById('reset-group-section').style.display='none';document.getElementById('settings-modal').classList.add('active')}});
document.getElementById('settings-close').addEventListener('click',()=>document.getElementById('settings-modal').classList.remove('active'));
document.getElementById('settings-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('active')});
document.getElementById('add-deck-modal-row').addEventListener('click',()=>{const s=document.getElementById('add-deck-modal-section');s.style.display=s.style.display==='none'?'block':'none'});
document.getElementById('settings-add-deck-btn').addEventListener('click',async()=>{const i=document.getElementById('settings-deck-input'),n=i.value.trim();if(!n){return}if(getDeck(n)){showToast('同じ名前のデッキがあります');return}decks.push({name:n,subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}});await saveDecks();i.value='';renderDeckList();showToast(`「${n}」を追加`);document.getElementById('settings-modal').classList.remove('active')});
document.getElementById('settings-deck-input').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();document.getElementById('settings-add-deck-btn').click()}});
document.getElementById('deck-ops-row').addEventListener('click',()=>{const s=document.getElementById('deck-ops-section');if(s.style.display==='none'){s.style.display='block';document.getElementById('deck-ops-select').innerHTML=decks.map(d=>`<option value="${esc(d.name)}">${esc(d.name)}</option>`).join('')}else{s.style.display='none'}});
document.getElementById('deck-edit-btn').addEventListener('click',()=>{const name=document.getElementById('deck-ops-select').value;if(name){document.getElementById('settings-modal').classList.remove('active');navigateTo('manage',name)}});
document.getElementById('deck-rename-btn').addEventListener('click',()=>{const name=document.getElementById('deck-ops-select').value;if(name){document.getElementById('settings-modal').classList.remove('active');renameDeckAction(name)}});
document.getElementById('deck-delete-btn').addEventListener('click',async()=>{const name=document.getElementById('deck-ops-select').value;if(name==='デフォルト'){showToast('デフォルトデッキは削除できません');return}if(name){document.getElementById('settings-modal').classList.remove('active');await deleteDeckAction(name)}});
document.getElementById('autoplay-settings-row').addEventListener('click',()=>{const s=document.getElementById('autoplay-settings-section');s.style.display=s.style.display==='none'?'block':'none'});
document.getElementById('reset-group-row').addEventListener('click',()=>{const s=document.getElementById('reset-group-section');s.style.display=s.style.display==='none'?'block':'none'});
document.getElementById('howto-row').addEventListener('click',()=>{const s=document.getElementById('howto-section');s.style.display=s.style.display==='none'?'block':'none'});
document.getElementById('csv-import-row').addEventListener('click',()=>{const s=document.getElementById('csv-import-section');if(s.style.display==='none'){s.style.display='block';document.getElementById('csv-import-deck').innerHTML=decks.map(d=>`<option value="${esc(d.name)}">${esc(d.name)}</option>`).join('')}else{s.style.display='none'}});
document.getElementById('csv-file').addEventListener('change',async e=>{const f=e.target.files[0];if(!f)return;const dn=document.getElementById('csv-import-deck').value;if(!dn){showToast('デッキを選択してください');return}document.getElementById('settings-modal').classList.remove('active');document.getElementById('loading').classList.remove('hidden');try{const text=await f.text();const lines=text.split(/\r?\n/).filter(l=>l.trim());let count=0;for(const line of lines){const p=parseCSVLine(line);if(p.length>=2&&p[0].trim()&&p[1].trim()){await addCard({question:p[0].trim(),answer:p[1].trim(),deck:dn,subdeck:'',lastRating:null,created:new Date().toISOString()},true);count++}}if(count){const dk=getDeck(dn);if(dk)dk.cardCount=(dk.cardCount||0)+count;if(!isGuest)cards=[];await saveDecks();renderDeckList()}showToast(`${count}問をインポートしました`)}catch(err){console.error(err);showToast('インポート失敗')}document.getElementById('loading').classList.add('hidden');e.target.value=''});
document.getElementById('reset-card-stats-row').addEventListener('click',async()=>{if(!confirm('全カードの◯×カウントとレーティングを初期状態にリセットしますか？'))return;if(isGuest){for(const c of cards){c.incorrectCount=0;c.correctCount=0;c.lastRating=null}LS.save('fc_cards',cards)}else{const snap=await cardsCol().get();const docs=snap.docs;for(let i=0;i<docs.length;i+=400){const batch=db.batch();docs.slice(i,i+400).forEach(d=>batch.update(d.ref,{incorrectCount:0,correctCount:0,lastRating:null}));await batch.commit()}}for(const dk of decks){dk.ratings={incorrect:0,correct:0,understood:0}}await saveDecks();showToast('カード統計をリセットしました');document.getElementById('settings-modal').classList.remove('active')});
document.getElementById('manage-settings-close').addEventListener('click',()=>document.getElementById('manage-settings-modal').classList.remove('active'));
document.getElementById('manage-settings-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('active')});

/* ========== Util ========== */
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function showToast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2500)}
function parseCSVLine(line){const r=[];let c='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(q){if(ch==='"'&&line[i+1]==='"'){c+='"';i++}else if(ch==='"'){q=false}else{c+=ch}}else{if(ch==='"'){q=true}else if(ch===','){r.push(c);c=''}else{c+=ch}}}r.push(c);return r}
</script>
</body>
</html>
