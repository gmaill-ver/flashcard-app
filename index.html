<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¦ãƒ«ãƒˆãƒ©Anki</title>
  <meta name="description" content="è³‡æ ¼è©¦é¨“å‘ã‘ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰å­¦ç¿’ã‚¢ãƒ—ãƒªã€‚ã„ã¤ã§ã‚‚ã©ã“ã§ã‚‚ã‚¹ãƒãƒ›ã§æš—è¨˜å­¦ç¿’ã€‚">
  <meta property="og:title" content="ã‚¦ãƒ«ãƒˆãƒ©Anki">
  <meta property="og:description" content="è³‡æ ¼è©¦é¨“å‘ã‘ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰å­¦ç¿’ã‚¢ãƒ—ãƒªã€‚ã„ã¤ã§ã‚‚ã©ã“ã§ã‚‚ã‚¹ãƒãƒ›ã§æš—è¨˜å­¦ç¿’ã€‚">
  <meta property="og:image" content="https://flash-cardapp.netlify.app/ogp.png">
  <meta property="og:url" content="https://flash-cardapp.netlify.app">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ã‚¦ãƒ«ãƒˆãƒ©Anki">
  <meta name="twitter:description" content="è³‡æ ¼è©¦é¨“å‘ã‘ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰å­¦ç¿’ã‚¢ãƒ—ãƒªã€‚ã„ã¤ã§ã‚‚ã©ã“ã§ã‚‚ã‚¹ãƒãƒ›ã§æš—è¨˜å­¦ç¿’ã€‚">
  <meta name="twitter:image" content="https://flash-cardapp.netlify.app/ogp.png">
  <link rel="icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196f3">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PLHLN3NH45"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-PLHLN3NH45');</script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f0f0f0;min-height:100vh;color:#333}
    .page{display:none;max-width:600px;margin:0 auto;padding:0 16px 40px;animation:fadeIn .25s ease}
    .page.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .login-page{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center}
    .login-logo{font-size:3rem;margin-bottom:8px}.login-title{font-size:1.6rem;font-weight:700;margin-bottom:4px}.login-sub{font-size:.9rem;color:#888;margin-bottom:40px}
    .login-btn{display:flex;align-items:center;gap:12px;padding:14px 32px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:1rem;cursor:pointer;transition:all .2s;width:280px;justify-content:center;margin-bottom:12px}
    .login-btn:hover{background:#f5f5f5;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .login-btn-google{border-color:#4285f4;font-weight:500}.login-btn-guest{border-color:#ccc;color:#666}.login-google-icon{width:20px;height:20px}

    .loading-overlay{position:fixed;inset:0;background:#f0f0f0;z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}
    .loading-overlay.hidden{display:none}
    .spinner{width:36px;height:36px;border:3px solid #ddd;border-top-color:#2196f3;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .app-header{background:#fff;border-bottom:1px solid #ddd;padding:12px 16px;margin-bottom:0;display:flex;align-items:center;gap:10px}
    .app-header h1{font-size:1.05rem;font-weight:700;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .header-back{background:none;border:none;font-size:1.4rem;cursor:pointer;color:#2196f3;padding:4px 8px;display:none}
    .header-back.visible{display:block}
    .header-actions{display:flex;gap:4px;align-items:center}
    .header-icon-btn{background:none;border:none;font-size:1.1rem;cursor:pointer;padding:6px 8px;border-radius:6px;color:#555}
    .header-icon-btn:hover{background:#eee}
    .header-user{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:#f5f5f5;cursor:pointer;overflow:hidden}
    .header-user:hover{background:#eee}

    /* ãƒ›ãƒ¼ãƒ ã‚¿ãƒ– */
    .home-tabs{display:flex;background:#fff;border-bottom:1px solid #ddd;margin:0 -16px 16px;padding:0 16px}
    .home-tab{flex:1;padding:12px;border:none;background:none;font-size:.9rem;cursor:pointer;color:#888;font-weight:500;border-bottom:2px solid transparent;transition:all .2s}
    .home-tab.active{color:#2196f3;border-bottom-color:#2196f3}
    .home-section{display:none}.home-section.active{display:block}

    /* Claude Chat */
    .chat-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px;padding:12px;background:#f9fafb;border-radius:8px;min-height:300px;max-height:calc(100vh - 260px)}
    .chat-message{display:flex;gap:8px;max-width:85%;animation:chatIn .3s ease-out}
    .chat-message.user{align-self:flex-end;flex-direction:row-reverse}
    .chat-message.assistant{align-self:flex-start}
    .chat-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;flex-shrink:0}
    .chat-message.user .chat-avatar{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff}
    .chat-message.assistant .chat-avatar{background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff}
    .chat-bubble{padding:10px 14px;border-radius:12px;font-size:.85rem;line-height:1.5;word-break:break-word}
    .chat-message.user .chat-bubble{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border-bottom-right-radius:4px}
    .chat-message.assistant .chat-bubble{background:#fff;color:#333;border:1px solid #e5e7eb;border-bottom-left-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .chat-bubble pre{background:#1f2937;color:#e5e7eb;padding:8px 10px;border-radius:6px;overflow-x:auto;font-size:.8rem;margin:6px 0}
    .chat-bubble code{font-family:monospace}
    .chat-input-wrap{display:flex;gap:8px;padding-top:8px}
    .chat-input{flex:1;border:1px solid #ddd;border-radius:10px;padding:10px 14px;font-size:.85rem;resize:none;outline:none;font-family:inherit;transition:border-color .2s}
    .chat-input:focus{border-color:#3b82f6}
    .chat-send{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border:none;border-radius:10px;padding:10px 18px;font-size:.85rem;cursor:pointer;font-weight:600;white-space:nowrap}
    .chat-send:disabled{opacity:.5;cursor:not-allowed}
    .chat-loading span{display:inline-block;width:6px;height:6px;background:#aaa;border-radius:50%;margin:0 2px;animation:bounce .6s infinite alternate}
    .chat-loading span:nth-child(2){animation-delay:.2s}
    .chat-loading span:nth-child(3){animation-delay:.4s}
    @keyframes chatIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes bounce{to{transform:translateY(-6px)}}

    .deck-list{display:flex;flex-direction:column;gap:4px}
    .deck-card{background:#fff;border-radius:12px;padding:14px 18px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:box-shadow .2s,transform .15s;border:1px solid #e0e0e0}
    .deck-card:hover{box-shadow:0 2px 12px rgba(0,0,0,.08);transform:translateY(-1px)}
    .deck-card:active{transform:scale(.99)}
    .deck-card-name{font-size:1rem;font-weight:600}
    .deck-count{font-size:.78rem;color:#888}
    .deck-chevron{font-size:.7rem;color:#999;flex-shrink:0}
    .deck-manage-btn{margin-left:auto;background:none;border:none;cursor:pointer;font-size:1rem;padding:4px 8px;border-radius:6px;color:#999;flex-shrink:0}
    .deck-manage-btn:hover{background:#f0f0f0;color:#555}
    .badge-public{font-size:.65rem;background:#e8f5e9;color:#2e7d32;padding:1px 8px;border-radius:10px;font-weight:400}

    .subdeck-card{margin-left:24px;background:#fafafa;border-radius:10px;padding:10px 16px;cursor:pointer;border:1px solid #eee;transition:all .2s;font-size:.9rem;font-weight:500}
    .subdeck-card:hover{background:#f0f0f0}
    .subdeck-study-all{color:#2196f3}

    .add-deck-row{display:flex;gap:8px}
    .add-deck-row input{flex:1;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:.95rem;background:#fafafa}
    .add-deck-row input:focus{outline:none;border-color:#2196f3}

    .btn{padding:10px 20px;border:none;border-radius:8px;font-size:.95rem;cursor:pointer;transition:all .2s;font-weight:500}
    .btn:active{transform:scale(.97)}
    .btn-blue{background:#2196f3;color:#fff}.btn-blue:hover{background:#1976d2}
    .btn-sm{padding:6px 14px;font-size:.8rem}
    .btn-gray{background:#e0e0e0;color:#555}
    .btn-red{background:#ef5350;color:#fff}.btn-red:hover{background:#d32f2f}
    .btn-green{background:#4caf50;color:#fff}.btn-green:hover{background:#388e3c}
    .btn-outline{background:none;border:1px solid #ddd;color:#555}.btn-outline:hover{background:#f5f5f5}


    /* å…¬é–‹ãƒ‡ãƒƒã‚­ */
    .pub-deck-card{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;margin-bottom:8px}
    .pub-deck-title{font-size:1rem;font-weight:600;margin-bottom:4px}
    .pub-deck-meta{font-size:.78rem;color:#888;margin-bottom:4px;display:flex;gap:10px}
    .pub-deck-desc{font-size:.82rem;color:#666;margin-bottom:10px}
    .pub-deck-actions{display:flex;gap:8px}

    /* å­¦ç¿’ */
    .study-deck-name{font-size:.85rem;color:#888;text-align:center;margin-bottom:8px;margin-top:16px}
    .study-progress{font-size:.85rem;color:#666;text-align:center;margin-bottom:12px}
    .study-progress-bar{height:4px;background:#e0e0e0;border-radius:2px;margin-top:6px;overflow:hidden}
    .study-progress-fill{height:100%;background:#4caf50;border-radius:2px;transition:width .3s}
    .study-filters{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
    .study-filter-btn{padding:6px 14px;border:1px solid #ddd;border-radius:20px;background:#fff;font-size:.78rem;cursor:pointer;white-space:nowrap;color:#666;transition:all .2s}
    .study-filter-btn.active{background:#333;color:#fff;border-color:#333}
    .study-filter-btn .filter-count{margin-left:4px;opacity:.7}
    .study-sort{margin-bottom:12px;display:flex;align-items:center;gap:8px}.study-sort select{padding:6px 12px;border:1px solid #ddd;border-radius:8px;font-size:.8rem;background:#fff;color:#555;cursor:pointer}
    .study-icon-btn{width:36px;height:36px;border:1px solid #ddd;border-radius:8px;background:#fff;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#555;transition:all .2s;flex-shrink:0}
    .study-icon-btn:hover{background:#f0f0f0}.study-icon-btn.active{background:#e3f2fd;border-color:#2196f3;color:#1565c0}
    #shuffle-btn{filter:grayscale(1) opacity(.45)}
    .anki-card{background:#fff;border-radius:12px;min-height:280px;display:flex;flex-direction:column;justify-content:flex-start;align-items:flex-start;padding:40px 24px 32px;text-align:left;font-size:1.15rem;line-height:1.8;cursor:pointer;border:1px solid #e0e0e0;position:relative;user-select:none}
    .anki-card-label{position:absolute;top:12px;left:16px;font-size:.75rem;color:#aaa;font-weight:600}
    .anki-card-subdeck{position:absolute;top:12px;right:16px;font-size:.7rem;color:#64b5f6;background:#e3f2fd;padding:2px 8px;border-radius:10px}
    .anki-card-stats{position:absolute;bottom:10px;right:12px;font-size:.9rem;letter-spacing:2px;text-align:right;max-width:80%;word-break:break-all;line-height:1.4}.mark-x{color:#e57373}.mark-o{color:#66bb6a}
    .anki-card-text{white-space:pre-wrap;word-break:break-word}
    .anki-divider{width:80%;border:none;border-top:1px solid #e0e0e0;margin:20px 0}
    .anki-answer-section{color:#1565c0}
    .anki-rating{display:flex;gap:8px;margin-top:20px}
    .anki-rating-btn{flex:1;padding:14px 8px;border:none;border-radius:8px;font-size:.9rem;cursor:pointer;font-weight:600;transition:all .15s}
    .anki-rating-btn:active{transform:scale(.96)}
    .anki-rating-btn.incorrect{background:#ffcdd2;color:#c62828}.anki-rating-btn.incorrect:hover{background:#ef9a9a}
    .anki-rating-btn.correct{background:#c8e6c9;color:#2e7d32}.anki-rating-btn.correct:hover{background:#a5d6a7}
    .anki-rating-btn.understood{background:#bbdefb;color:#1565c0}.anki-rating-btn.understood:hover{background:#90caf9}
    /* ç®¡ç† */
    .publish-section{background:#fff;border-radius:12px;padding:16px 20px;border:1px solid #e0e0e0;margin-bottom:12px}
    .publish-section h3{font-size:.9rem;color:#555;margin-bottom:10px}
    .publish-status{font-size:.85rem;color:#888;margin-bottom:10px}
    .publish-status.published{color:#2e7d32}
    .manage-subdeck-section{background:#fff;border-radius:12px;padding:16px 20px;border:1px solid #e0e0e0;margin-bottom:12px}
    .manage-subdeck-section h3{font-size:.9rem;color:#555;margin-bottom:10px}
    .subdeck-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
    .subdeck-chip{background:#e3f2fd;color:#1565c0;padding:4px 12px;border-radius:16px;font-size:.8rem;display:flex;align-items:center;gap:6px}
    .subdeck-chip-rename{cursor:pointer;opacity:.5;font-size:.75rem}.subdeck-chip-rename:hover{opacity:1}
    .subdeck-chip-del{cursor:pointer;opacity:.6;font-size:.9rem}.subdeck-chip-del:hover{opacity:1}
    .manage-form{background:#fff;border-radius:12px;padding:20px;border:1px solid #e0e0e0;margin-bottom:16px}
    .manage-form h3{font-size:.95rem;margin-bottom:16px;color:#555}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;font-size:.8rem;color:#888;margin-bottom:6px;font-weight:500}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:.95rem;background:#fafafa;color:#333}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#2196f3;background:#fff}
    .form-group textarea{min-height:200px;resize:vertical;font-family:inherit;line-height:1.6}
    .card-list-section{margin-top:20px}.card-list-section h3{font-size:.95rem;color:#555;margin-bottom:12px}
    .card-item{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:12px 16px;margin-bottom:8px;display:flex;align-items:flex-start;gap:12px}
    .card-item-content{flex:1;overflow:hidden}
    .card-item-q{font-weight:600;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
    .card-item-a{font-size:.8rem;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card-item-tags{display:flex;gap:4px;margin-top:4px}
    .card-item-tag{font-size:.68rem;padding:1px 8px;border-radius:10px}
    .tag-subdeck{background:#e3f2fd;color:#1565c0}.tag-incorrect{background:#ffcdd2;color:#c62828}.tag-correct{background:#c8e6c9;color:#2e7d32}.tag-understood{background:#bbdefb;color:#1565c0}
    .card-item-actions{display:flex;gap:4px}
    .card-item-btn{border:none;background:none;cursor:pointer;font-size:.95rem;padding:4px 8px;border-radius:6px}
    .card-item-btn:hover{background:#f0f0f0}
    .empty-state{text-align:center;padding:40px 20px;color:#aaa}.empty-state-icon{font-size:3rem;margin-bottom:12px}

    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
    .stat-card{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;text-align:center}
    .stat-value{font-size:1.8rem;font-weight:700;color:#2196f3}.stat-label{font-size:.8rem;color:#999;margin-top:4px}
    .stats-chart-wrap{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:16px;margin-bottom:20px}
    .stats-range{display:flex;gap:6px;margin-bottom:12px}
    .stats-range-btn{padding:6px 16px;border:1px solid #ddd;border-radius:20px;background:#fff;font-size:.8rem;cursor:pointer;color:#666;transition:all .2s}
    .stats-range-btn.active{background:#333;color:#fff;border-color:#333}

    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;justify-content:center;align-items:flex-end}
    .modal-overlay.active{display:flex}
    .modal{background:#fff;border-radius:16px 16px 0 0;width:100%;max-width:600px;padding:24px 20px;max-height:70vh;overflow-y:auto;animation:slideUp .25s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal h3{font-size:1rem;margin-bottom:16px}
    .modal-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #eee;font-size:.9rem}
    .modal-row:last-child{border-bottom:none}
    .modal-row input[type="number"]{width:60px;padding:6px;border:1px solid #ddd;border-radius:6px;text-align:center;font-size:.9rem}
    .modal-close{display:block;width:100%;padding:14px;margin-top:16px;background:#e0e0e0;border:none;border-radius:8px;font-size:.95rem;cursor:pointer}
    .modal-row-danger{color:#d32f2f;cursor:pointer}.modal-row-danger:hover{background:#fff5f5}

    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 24px;border-radius:8px;font-size:.85rem;z-index:200;opacity:0;transition:opacity .3s;pointer-events:none}
    .toast.show{opacity:1}

    @media(max-width:600px){.anki-card{min-height:220px;padding:24px 16px;font-size:1rem}}
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading"><div class="spinner"></div><div style="color:#888;font-size:.9rem" id="loading-msg"></div></div>
  <script>!function(){const m=['ä»Šæ—¥ã‚‚é ‘å¼µã‚ã†ï¼','ç¶™ç¶šã¯åŠ›ãªã‚Š','åŠªåŠ›ã¯è£åˆ‡ã‚‰ãªã„','ä¸€æ­©ä¸€æ­©ã€ç¢ºå®Ÿã«','æ˜¨æ—¥ã®è‡ªåˆ†ã‚’è¶…ãˆã‚','ã‚„ã‚Œã°ã§ãã‚‹ï¼','åˆæ ¼ã¾ã§ã‚ã¨å°‘ã—ï¼','æœªæ¥ã®è‡ªåˆ†ã«æŠ•è³‡ä¸­','ä»Šæ—¥ã®ç©ã¿é‡ã­ãŒæ˜æ—¥ã®åŠ›','å¤¢ã¯é€ƒã’ãªã„ã€é€ƒã’ã‚‹ã®ã¯è‡ªåˆ†','å¤§å‰ â˜€','ä¸­å‰','å°å‰','å‰','æœ«å‰ï¼ˆã§ã‚‚é ‘å¼µã‚Œã°å¤§å‰ï¼‰','ä¸€æœŸä¸€ä¼š','ä¸ƒè»¢å…«èµ·','æ¸©æ•…çŸ¥æ–°','æ—¥é€²æœˆæ­©','åƒé‡Œã®é“ã‚‚ä¸€æ­©ã‹ã‚‰','çŸ³ã®ä¸Šã«ã‚‚ä¸‰å¹´','åˆå¿—è²«å¾¹','ç‚¹æ»´ç©¿çŸ³','æ–‡æ­¦ä¸¡é“','çŸ¥è¡Œåˆä¸€','ã‚³ãƒ¼ãƒ’ãƒ¼ã§ã‚‚é£²ã¿ãªãŒã‚‰','ä»Šæ—¥ã‚‚ãˆã‚‰ã„ï¼','è„³ã¿ãã‚¦ã‚©ãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒƒãƒ—ä¸­','å¤©æ‰ã®æœã¯æš—è¨˜ã‹ã‚‰','æš—è¨˜ã®é¬¼ã¨åŒ–ã™','è‡ªåˆ†ãŒãƒ©ã‚¤ãƒãƒ«','çµ¶å¯¾å—ã‹ã‚‹','ä»Šæ—¥ä¸€ç•ªé ‘å¼µã£ã¦ã‚‹','SNSã¯ã»ã©ã»ã©ã«'];document.getElementById('loading-msg').textContent=m[Math.floor(Math.random()*m.length)]}()</script>

  <div class="page" id="page-login"><div class="login-page">
    <div class="login-logo">&#x1f4da;</div><div class="login-title">AnkiMaster</div>
    <div class="login-sub">è³‡æ ¼è©¦é¨“ã®ãŸã‚ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰å­¦ç¿’</div>
    <button class="login-btn login-btn-google" id="google-login-btn">
      <svg class="login-google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button class="login-btn login-btn-guest" id="guest-login-btn">&#x1f464; ãŠè©¦ã—ã§ä½¿ã†ï¼ˆã‚²ã‚¹ãƒˆï¼‰</button>
    <div id="user-count" style="margin-top:24px;font-size:.82rem;color:#aaa;display:none">&#x1f393; <span id="user-count-num"></span>äººãŒåˆ©ç”¨ä¸­</div>
  </div></div>

  <div class="app-header" id="app-header" style="display:none">
    <button class="header-back" id="back-btn">&#8592;</button>
    <h1 id="header-title">ãƒ‡ãƒƒã‚­</h1>
    <div class="header-actions">
      <button class="header-icon-btn" id="stats-btn" title="çµ±è¨ˆ">&#x1f4ca;</button>
      <button class="header-icon-btn" id="settings-btn" title="è¨­å®š">&#x2699;</button>
      <div class="header-user" id="header-user"><img id="header-avatar" style="width:100%;height:100%;object-fit:cover;display:none"><span id="header-user-icon" style="font-size:1.1rem">&#x1f464;</span></div>
    </div>
  </div>

  <!-- ãƒ›ãƒ¼ãƒ  -->
  <div class="page" id="page-home">
    <div class="home-tabs">
      <button class="home-tab active" data-tab="my" id="tab-my">ãƒã‚¤ãƒ‡ãƒƒã‚­</button>
      <button class="home-tab" data-tab="chat" id="tab-chat">AIãƒãƒ£ãƒƒãƒˆ</button>
      <button class="home-tab" data-tab="public" id="tab-public">å…¬é–‹ãƒ‡ãƒƒã‚­</button>
    </div>
    <div class="home-section active" id="section-my">
      <div class="deck-list" id="deck-list"></div>
    </div>
    <div class="home-section" id="section-chat">
      <div style="display:flex;flex-direction:column;height:calc(100vh - 180px)">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-message assistant"><div class="chat-avatar">ğŸ¤–</div><div class="chat-bubble">ã“ã‚“ã«ã¡ã¯ï¼è³‡æ ¼è©¦é¨“ã®å­¦ç¿’ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚è³ªå•ãŒã‚ã‚Œã°ã©ã†ãï¼</div></div>
        </div>
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="2"></textarea>
          <button class="chat-send" id="chat-send-btn">é€ä¿¡</button>
        </div>
      </div>
    </div>
    <div class="home-section" id="section-public">
      <div id="public-deck-list"></div>
      <div class="empty-state" id="public-loading" style="padding:20px"><div class="spinner" style="margin:0 auto 12px"></div>èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <!-- å­¦ç¿’ -->
  <div class="page" id="page-study">
    <div class="study-deck-name" id="study-deck-name"></div>
    <div class="study-filters" id="study-filters"></div>
    <div class="study-sort" id="study-sort"></div>
    <div class="study-progress"><span id="study-progress-text">0 / 0</span><div class="study-progress-bar"><div class="study-progress-fill" id="study-progress-fill" style="width:0%"></div></div></div>
    <div class="anki-card" id="anki-card">
      <span class="anki-card-label" id="anki-label">å•é¡Œ</span>
      <div class="anki-card-text" id="anki-question"></div>
      <hr class="anki-divider" id="anki-divider" style="display:none">
      <div class="anki-card-text anki-answer-section" id="anki-answer" style="display:none"></div>
      <div id="anki-detail-wrap" style="display:none"><span id="anki-detail-toggle" style="color:#2196f3;font-size:.82rem;cursor:pointer;margin-top:8px;display:inline-block">è©³ã—ã â–¼</span><div class="anki-card-text" id="anki-detail" style="display:none;margin-top:8px;font-size:.9rem;color:#666;white-space:pre-wrap;word-break:break-word"></div></div>
      <div class="anki-card-stats" id="anki-card-stats" style="display:none"></div>
    </div>
    <div class="anki-rating" id="anki-rating" style="display:none">
      <button class="anki-rating-btn correct" data-rating="correct">â—¯</button>
      <button class="anki-rating-btn incorrect" data-rating="incorrect">Ã—</button>
      <button class="anki-rating-btn understood" data-rating="understood">&#x1f44d;</button>
    </div>
  </div>

  <!-- ã‚«ãƒ¼ãƒ‰ç®¡ç† -->
  <div class="page" id="page-manage">
    <div class="manage-form">
      <h3 id="manage-form-title">ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </h3>
      <form id="card-form">
        <div class="form-group" id="subdeck-select-group" style="display:none"><label>ã‚µãƒ–ãƒ‡ãƒƒã‚­</label><select id="card-subdeck-select"><option value="">ãªã—ï¼ˆç›´ä¸‹ï¼‰</option></select></div>
        <div class="form-group"><label>å•é¡Œï¼ˆè¡¨é¢ï¼‰</label><textarea id="card-question" placeholder="å•é¡Œã‚’å…¥åŠ›"></textarea></div>
        <div class="form-group"><label>ç­”ãˆï¼ˆè£é¢ï¼‰</label><textarea id="card-answer" placeholder="ç­”ãˆã‚’å…¥åŠ›"></textarea></div>
        <div class="form-group"><label>è©³ç´°ãƒ»è§£èª¬ï¼ˆä»»æ„ï¼‰</label><textarea id="card-detail" placeholder="åˆ¤ä¾‹ãƒ»æ¡æ–‡ãƒ»è§£èª¬ãªã©" style="min-height:100px"></textarea></div>
        <div style="display:flex;gap:8px"><button type="submit" class="btn btn-blue" style="flex:1" id="card-submit-btn">è¿½åŠ </button><button type="button" class="btn btn-gray" id="card-cancel-btn" style="display:none">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>
      </form>
    </div>
    <div class="card-list-section"><h3 id="manage-card-count">ã‚«ãƒ¼ãƒ‰ (0æš)</h3><div id="manage-subdeck-filter" style="margin-bottom:10px"></div><input type="text" id="manage-search" placeholder="ã‚«ãƒ¼ãƒ‰ã‚’æ¤œç´¢..." style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:.85rem;margin-bottom:10px;background:#fff"><div id="manage-card-list"></div><div id="manage-pagination" style="display:flex;justify-content:center;align-items:center;gap:12px;margin-top:12px"></div></div>
  </div>

  <!-- çµ±è¨ˆ -->
  <div class="page" id="page-stats">
    <div style="margin:16px 0 12px"><select id="stats-deck-filter" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:.85rem;background:#fff;color:#555"></select></div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="s-total-reviews">0</div><div class="stat-label">ç·å­¦ç¿’å›æ•°</div></div>
      <div class="stat-card"><div class="stat-value" id="s-study-days">0</div><div class="stat-label">å­¦ç¿’æ—¥æ•°</div></div>
    </div>
    <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="stat-card"><div class="stat-value" id="s-correct">0</div><div class="stat-label">â—¯</div></div>
      <div class="stat-card"><div class="stat-value" id="s-incorrect">0</div><div class="stat-label">Ã—</div></div>
      <div class="stat-card"><div class="stat-value" id="s-understood">0</div><div class="stat-label">&#x1f44d;</div></div>
    </div>
    <div class="stats-chart-wrap">
      <div class="stats-range">
        <button class="stats-range-btn active" data-range="day">æ—¥</button>
        <button class="stats-range-btn" data-range="week">é€±</button>
        <button class="stats-range-btn" data-range="month">æœˆ</button>
      </div>
      <canvas id="stats-chart"></canvas>
    </div>
  </div>

  <div class="modal-overlay" id="settings-modal"><div class="modal">
    <h3>&#x2699; è¨­å®š</h3>
    <div class="modal-row" id="add-deck-modal-row">&#x2795; ãƒ‡ãƒƒã‚­ã‚’è¿½åŠ </div>
    <div id="add-deck-modal-section" style="display:none;padding:8px 0"><div style="display:flex;gap:8px"><input type="text" id="settings-deck-input" placeholder="ãƒ‡ãƒƒã‚­åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:.9rem"><button class="btn btn-blue btn-sm" id="settings-add-deck-btn">è¿½åŠ </button></div></div>
    <div class="modal-row" id="deck-ops-row">&#x1f4c1; ãƒ‡ãƒƒã‚­æ“ä½œ</div>
    <div id="deck-ops-section" style="display:none;padding:8px 0"><select id="deck-ops-select" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:.9rem;margin-bottom:8px"></select><div style="display:flex;gap:8px"><button class="btn btn-blue btn-sm" id="deck-edit-btn" style="flex:1">ç·¨é›†</button><button class="btn btn-gray btn-sm" id="deck-rename-btn" style="flex:1">åç§°å¤‰æ›´</button><button class="btn btn-red btn-sm" id="deck-delete-btn" style="flex:1">å‰Šé™¤</button></div></div>
    <div class="modal-row" id="csv-import-row">&#x1f4e5; CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
    <div id="csv-import-section" style="display:none;padding:8px 0"><select id="csv-import-deck" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:.9rem;margin-bottom:8px"></select><select id="csv-import-subdeck" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:.9rem;margin-bottom:8px"></select><label class="btn btn-outline btn-sm" style="display:block;text-align:center;cursor:pointer">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<input type="file" id="csv-file" accept=".csv" style="display:none"></label><div style="font-size:.72rem;color:#999;margin-top:6px">å½¢å¼: å•é¡Œ,å›ç­”,è©³ç´°ï¼ˆ1è¡Œ1å•ã€è©³ç´°ã¯ä»»æ„ï¼‰</div></div>
    <div class="modal-row" id="autoplay-settings-row">&#x25b6;&#xfe0e; å†ç”Ÿ</div>
    <div id="autoplay-settings-section" style="display:none;padding:4px 0">
      <div class="modal-row"><span>å•é¡Œã®è¡¨ç¤ºæ™‚é–“ï¼ˆç§’ï¼‰</span><input type="number" id="cfg-q-delay" value="3" min="1" max="30"></div>
      <div class="modal-row"><span>ç­”ãˆã®è¡¨ç¤ºæ™‚é–“ï¼ˆç§’ï¼‰</span><input type="number" id="cfg-a-delay" value="3" min="1" max="30"></div>
    </div>
    <div class="modal-row" id="howto-row">&#x1f4d6; ä½¿ã„æ–¹</div>
    <div id="howto-section" style="display:none;padding:12px 0;font-size:.82rem;color:#555;line-height:1.9">
      <b>1. ãƒ‡ãƒƒã‚­ã‚’ä½œæˆ</b><br>è¨­å®š â†’ ã€Œãƒ‡ãƒƒã‚­ã‚’è¿½åŠ ã€ã‹ã‚‰ç§‘ç›®åã‚’å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚<br><br>
      <b>2. ã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²</b><br>ãƒ›ãƒ¼ãƒ ç”»é¢ã®ãƒ‡ãƒƒã‚­å³å´ã® &#x1f4cb; ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã€å•é¡Œã¨å›ç­”ã‚’å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚ã‚µãƒ–ãƒ‡ãƒƒã‚­ï¼ˆå°åˆ†é¡ï¼‰ã‚’è¿½åŠ ã—ãŸã„å ´åˆã¯ã€ã‚«ãƒ¼ãƒ‰ç®¡ç†ç”»é¢ã® &#x2699; ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰è¿½åŠ ã§ãã¾ã™ã€‚CSVã§ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚‚å¯èƒ½ã§ã™ã€‚<br><br>
      <b>3. å­¦ç¿’é–‹å§‹</b><br>ãƒ›ãƒ¼ãƒ ç”»é¢ã§ãƒ‡ãƒƒã‚­ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å­¦ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç­”ãˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã§å•é¡Œã«æˆ»ã‚Šã¾ã™ã€‚<br><br>
      <b>4. å­¦ç¿’ã‚µã‚¤ã‚¯ãƒ«</b><br>æœ€åˆã¯ã€Œå…¨ã€ã‚«ãƒ†ã‚´ãƒªã§å…¨å•è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
      &#x2022; ã‚ã‹ã‚‰ãªã‹ã£ãŸ â†’ <b>Ã—</b> ã‚’ã‚¿ãƒƒãƒ—<br>
      &#x2022; æ­£è§£ã§ããŸ â†’ <b>â—¯</b> ã‚’ã‚¿ãƒƒãƒ—<br>
      &#x2022; å®Œå…¨ã«ç†è§£ã—ãŸ â†’ <b>&#x1f44d;</b> ã‚’ã‚¿ãƒƒãƒ—<br><br>
      Ã—ã®ã‚«ãƒ¼ãƒ‰ã‚’é‡ç‚¹çš„ã«ç¹°ã‚Šè¿”ã—ã€å°‘ã—ãšã¤â—¯ â†’ &#x1f44d; ã¸ç§»å‹•ã•ã›ã¦ã„ãã®ãŒå­¦ç¿’ã®ã‚µã‚¤ã‚¯ãƒ«ã§ã™ã€‚<br><br>
      <b>5. çµ±è¨ˆã§ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒ</b><br>&#x1f4ca; ã‚¢ã‚¤ã‚³ãƒ³ã§å­¦ç¿’ã®é€²æ—ã‚’ã‚°ãƒ©ãƒ•ã§ç¢ºèªã§ãã¾ã™ã€‚æ¯æ—¥ã‚³ãƒ„ã‚³ãƒ„ç¶šã‘ã¦ã€å­¦ç¿’æ—¥æ•°ã‚’ç©ã¿ä¸Šã’ã¦ã„ãã¾ã—ã‚‡ã†ï¼
      <br><br><div style="background:#f5f5f5;border-radius:8px;padding:10px 12px;font-size:.78rem;color:#888;line-height:1.7">&#x2139;&#xfe0e; ç¾åœ¨ã™ã¹ã¦ã®ãƒ‡ãƒƒã‚­ã¯ç„¡æ–™ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚ä»Šå¾Œã€ä¸€éƒ¨ã®é«˜å“è³ªãƒ‡ãƒƒã‚­ï¼ˆè³‡æ ¼è©¦é¨“å‘ã‘å…¬å¼å¯¾ç­–é›†ãªã©ï¼‰ã‚’æœ‰æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦æä¾›ã™ã‚‹äºˆå®šã§ã™ã€‚ç„¡æ–™ãƒ‡ãƒƒã‚­ã¯ä»Šå¾Œã‚‚ç¶™ç¶šã—ã¦ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</div>
    </div>
    <div class="modal-row modal-row-danger" id="reset-group-row">&#x1f504; ãƒªã‚»ãƒƒãƒˆ</div>
    <div id="reset-group-section" style="display:none;padding:4px 0">
      <div class="modal-row modal-row-danger" id="reset-card-stats-row">ã‚«ãƒ¼ãƒ‰çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ</div>
      <div class="modal-row modal-row-danger" id="reset-stats-btn">å­¦ç¿’çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ</div>
    </div>
    <div class="modal-row modal-row-danger" id="logout-row">&#x1f6aa; ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
    <button class="modal-close" id="settings-close">é–‰ã˜ã‚‹</button>
  </div></div>
  <div class="modal-overlay" id="manage-settings-modal"><div class="modal">
    <h3>&#x2699; ãƒ‡ãƒƒã‚­è¨­å®š</h3>
    <div style="margin-bottom:16px">
      <div style="font-size:.9rem;color:#555;margin-bottom:10px;font-weight:600">&#x1f4c2; ã‚µãƒ–ãƒ‡ãƒƒã‚­</div>
      <div class="subdeck-chips" id="subdeck-chips"></div>
      <div class="add-deck-row"><input type="text" id="new-subdeck-input" placeholder="ã‚µãƒ–ãƒ‡ãƒƒã‚­å"><button class="btn btn-blue btn-sm" id="add-subdeck-btn">è¿½åŠ </button></div>
    </div>
    <div id="publish-section">
      <div style="font-size:.9rem;color:#555;margin-bottom:10px;font-weight:600">&#x1f4e4; å…¬é–‹è¨­å®š</div>
      <div class="publish-status" id="publish-status">ã“ã®ãƒ‡ãƒƒã‚­ã¯å…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
      <div id="publish-desc-group" class="form-group" style="margin-bottom:10px">
        <label>èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="publish-desc" placeholder="ãƒ‡ãƒƒã‚­ã®èª¬æ˜ã‚’å…¥åŠ›">
      </div>
      <div style="display:flex;gap:8px" id="publish-buttons">
        <button class="btn btn-green btn-sm" id="publish-btn">å…¬é–‹ã™ã‚‹</button>
      </div>
    </div>
    <button class="modal-close" id="manage-settings-close">é–‰ã˜ã‚‹</button>
  </div></div>
  <div class="toast" id="toast"></div>

<script>
function showLoading(){document.getElementById('loading').classList.remove('hidden')}

/* ========== Firebase ========== */
firebase.initializeApp({apiKey:"AIzaSyCFliHkmMAxap7386JJZb81o3dbI5uJFGU",authDomain:"ankimaster-395d5.firebaseapp.com",projectId:"ankimaster-395d5",storageBucket:"ankimaster-395d5.firebasestorage.app",messagingSenderId:"679225068510",appId:"1:679225068510:web:8acae35eb5ee7537d26b4f",measurementId:"G-PLHLN3NH45"});
const auth=firebase.auth(),db=firebase.firestore();
db.enablePersistence().catch(()=>{});

/* ========== State ========== */
let currentUser=null,isGuest=false;
let cards=[],decks=[],stats={reviews:0,incorrect:0,correct:0,understood:0};
let currentDeck=null,currentSubdeck=null,studyCards=[],studyIndex=0,answerShown=false,studyFilter='all';
let isPlaying=false,playTimer=null,editingId=null,studySort=null;
let isPublicStudy=false,activeHomeTab='my',currentPage='home',expandedDecks=new Set(),manageSubdeckFilter='',manageSearch='',managePage=0;
const MANAGE_PER_PAGE=50;
let dailyStats={},statsChart=null,statsRange='day',statsFilterDeck='';

/* ========== LS ========== */
const LS={load(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}},save(k,v){localStorage.setItem(k,JSON.stringify(v))}};

/* ========== Data ========== */
function userDoc(){return db.collection('users').doc(currentUser.uid)}
function cardsCol(){return userDoc().collection('cards')}
function migrateDecks(r){if(!r||!r.length)return[{name:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}}];if(typeof r[0]==='string')return r.map(n=>({name:n,subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}}));return r.map(d=>({name:d.name,subdecks:d.subdecks||[],publishedId:d.publishedId||null,cardCount:d.cardCount!=null?d.cardCount:0,ratings:d.ratings||{incorrect:0,correct:0,understood:0}}))}
function migrateStats(r){const s=r||{};return{reviews:s.reviews||0,incorrect:s.incorrect||s.hard||0,correct:s.correct||s.good||0,understood:s.understood||s.easy||0}}

async function loadData(){
  if(isGuest){decks=migrateDecks(LS.load('fc_decks',null));cards=LS.load('fc_cards',[]);stats=migrateStats(LS.load('fc_stats',null));dailyStats=LS.load('fc_daily',{});if(!cards.length)seedSample();syncAllDeckMeta();return}
  try{
    const doc=await userDoc().get();let needsMeta=false;
    if(doc.exists){const d=doc.data(),raw=d.decks;decks=migrateDecks(raw);stats=migrateStats(d.stats);dailyStats=d.dailyStats||{};needsMeta=raw&&raw.length>0&&raw[0].cardCount==null}
    else{decks=[{name:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}}];stats={reviews:0,incorrect:0,correct:0,understood:0};await userDoc().set({decks,stats});await seedFS();syncAllDeckMeta();await saveDecks();try{await db.collection('meta').doc('stats').set({totalUsers:firebase.firestore.FieldValue.increment(1)},{merge:true})}catch(e){console.error(e)}}
    if(needsMeta){const snap=await cardsCol().get();const all=snap.docs.map(d=>({id:d.id,...d.data()}));for(const dk of decks){const dc=all.filter(c=>c.deck===dk.name);dk.cardCount=dc.length;dk.ratings={incorrect:dc.filter(c=>c.lastRating==='incorrect').length,correct:dc.filter(c=>c.lastRating==='correct').length,understood:dc.filter(c=>c.lastRating==='understood').length}};await saveDecks()}
    cards=[];
  }catch(e){console.error(e);showToast('èª­ã¿è¾¼ã¿å¤±æ•—')}
}
async function saveDecks(){if(isGuest){LS.save('fc_decks',decks);return}try{await userDoc().update({decks})}catch(e){console.error(e)}}
async function saveStats(){if(isGuest){LS.save('fc_stats',stats);LS.save('fc_daily',dailyStats);return}try{await userDoc().update({stats,dailyStats})}catch(e){console.error(e)}}
async function addCard(c,skipMeta){if(isGuest){c.id=Date.now().toString()+Math.random();cards.push(c);LS.save('fc_cards',cards)}else{try{const r=await cardsCol().add(c);cards.push({id:r.id,...c})}catch(e){console.error(e);showToast('ä¿å­˜å¤±æ•—');return}}if(!skipMeta){const dk=getDeck(c.deck);if(dk){dk.cardCount=(dk.cardCount||0)+1;await saveDecks()}}}
async function updateCard(id,data){const i=cards.findIndex(c=>c.id===id);if(i===-1)return;cards[i]={...cards[i],...data};if(isGuest){LS.save('fc_cards',cards);return}try{await cardsCol().doc(id).update(data)}catch(e){console.error(e)}}
async function removeCard(id){const old=cards.find(c=>c.id===id);cards=cards.filter(c=>c.id!==id);if(isGuest){LS.save('fc_cards',cards)}else{try{await cardsCol().doc(id).delete()}catch(e){console.error(e)}}if(old){const dk=getDeck(old.deck);if(dk){dk.cardCount=Math.max(0,(dk.cardCount||0)-1);if(old.lastRating&&dk.ratings)dk.ratings[old.lastRating]=Math.max(0,(dk.ratings[old.lastRating]||0)-1);await saveDecks()}}}

function todayStr(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function trackDaily(r,dk){const t=todayStr();if(!dailyStats[t])dailyStats[t]={reviews:0,incorrect:0,correct:0,understood:0,decks:{}};dailyStats[t].reviews++;dailyStats[t][r]++;if(dk){if(!dailyStats[t].decks)dailyStats[t].decks={};if(!dailyStats[t].decks[dk])dailyStats[t].decks[dk]={reviews:0,incorrect:0,correct:0,understood:0};dailyStats[t].decks[dk].reviews++;dailyStats[t].decks[dk][r]++}}
function syncAllDeckMeta(){for(const dk of decks){const dc=cards.filter(c=>c.deck===dk.name);dk.cardCount=dc.length;dk.ratings={incorrect:dc.filter(c=>c.lastRating==='incorrect').length,correct:dc.filter(c=>c.lastRating==='correct').length,understood:dc.filter(c=>c.lastRating==='understood').length}}}
function syncCurrentDeckMeta(){const dk=getDeck(currentDeck);if(!dk)return;const dc=cards.filter(c=>c.deck===currentDeck);dk.cardCount=dc.length;dk.ratings={incorrect:dc.filter(c=>c.lastRating==='incorrect').length,correct:dc.filter(c=>c.lastRating==='correct').length,understood:dc.filter(c=>c.lastRating==='understood').length}}
async function loadDeckCards(name){if(isGuest)return;try{const snap=await cardsCol().where('deck','==',name).get();cards=snap.docs.map(d=>({id:d.id,...d.data()}))}catch(e){console.error(e);showToast('ã‚«ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å¤±æ•—')}}

function seedSample(){cards=[{id:'1',question:'æ°‘æ³•ç¬¬1æ¡ã®3ã¤ã®åŸºæœ¬åŸå‰‡ã¯ï¼Ÿ',answer:'â‘ å…¬å…±ã®ç¦ç¥‰é©åˆã®åŸå‰‡\nâ‘¡ä¿¡ç¾©èª å®Ÿã®åŸå‰‡\nâ‘¢æ¨©åˆ©æ¿«ç”¨ç¦æ­¢ã®åŸå‰‡',deck:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',subdeck:'',lastRating:null,created:new Date().toISOString()},{id:'2',question:'æ†²æ³•ç¬¬9æ¡ã®å†…å®¹ã¯ï¼Ÿ',answer:'ç¬¬1é …ï¼šæˆ¦äº‰ã®æ”¾æ£„\nç¬¬2é …ï¼šæˆ¦åŠ›ã®ä¸ä¿æŒã€äº¤æˆ¦æ¨©ã®å¦èª',deck:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',subdeck:'',lastRating:null,created:new Date().toISOString()},{id:'3',question:'å°Šå±æ®ºé‡ç½°è¦å®šé•æ†²åˆ¤æ±ºã®ãƒã‚¤ãƒ³ãƒˆã¯ï¼Ÿ',answer:'åˆ‘æ³•200æ¡ã¯æ³•ã®ä¸‹ã®å¹³ç­‰ï¼ˆæ†²æ³•14æ¡1é …ï¼‰ã«é•åã—ç„¡åŠ¹ã€‚',deck:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',subdeck:'',lastRating:null,created:new Date().toISOString()}];LS.save('fc_cards',cards)}
async function seedFS(){const ss=[{question:'æ°‘æ³•ç¬¬1æ¡ã®3ã¤ã®åŸºæœ¬åŸå‰‡ã¯ï¼Ÿ',answer:'â‘ å…¬å…±ã®ç¦ç¥‰é©åˆã®åŸå‰‡\nâ‘¡ä¿¡ç¾©èª å®Ÿã®åŸå‰‡\nâ‘¢æ¨©åˆ©æ¿«ç”¨ç¦æ­¢ã®åŸå‰‡',deck:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',subdeck:'',lastRating:null,created:new Date().toISOString()},{question:'æ†²æ³•ç¬¬9æ¡ã®å†…å®¹ã¯ï¼Ÿ',answer:'ç¬¬1é …ï¼šæˆ¦äº‰ã®æ”¾æ£„\nç¬¬2é …ï¼šæˆ¦åŠ›ã®ä¸ä¿æŒã€äº¤æˆ¦æ¨©ã®å¦èª',deck:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',subdeck:'',lastRating:null,created:new Date().toISOString()}];for(const s of ss){const r=await cardsCol().add(s);cards.push({id:r.id,...s})}}

/* ========== Auth ========== */
document.getElementById('google-login-btn').addEventListener('click',async()=>{try{await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())}catch(e){if(e.code!=='auth/popup-closed-by-user')showToast('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—')}});
document.getElementById('guest-login-btn').addEventListener('click',()=>{isGuest=true;currentUser=null;initApp()});
document.getElementById('logout-row').addEventListener('click',async()=>{document.getElementById('settings-modal').classList.remove('active');if(isGuest){isGuest=false;showPage('login');document.getElementById('app-header').style.display='none';return}await auth.signOut()});
auth.onAuthStateChanged(async u=>{if(u&&!isGuest){currentUser=u;isGuest=false;await initApp()}else if(!isGuest){currentUser=null;document.getElementById('loading').classList.add('hidden');document.getElementById('app-header').style.display='none';showPage('login');try{const m=await db.collection('meta').doc('stats').get();if(m.exists){const n=m.data().totalUsers||0;if(n>=100){document.getElementById('user-count-num').textContent=n;document.getElementById('user-count').style.display='block'}}}catch(e){}}});
async function initApp(){showLoading();await loadData();document.getElementById('loading').classList.add('hidden');document.getElementById('app-header').style.display='flex';if(!isGuest&&currentUser?.photoURL){document.getElementById('header-avatar').src=currentUser.photoURL;document.getElementById('header-avatar').style.display='block';document.getElementById('header-user-icon').style.display='none'}else{document.getElementById('header-avatar').style.display='none';document.getElementById('header-user-icon').style.display='block'}navigateTo('home')}

/* ========== Nav ========== */
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+id).classList.add('active')}
async function navigateTo(page,data){
  stopAutoPlay();isPublicStudy=false;currentPage=page;
  const back=document.getElementById('back-btn'),title=document.getElementById('header-title');
  switch(page){
    case'home':showPage('home');back.classList.remove('visible');title.textContent='ã‚¦ãƒ«ãƒˆãƒ©Anki';renderDeckList();setHomeTab(activeHomeTab);break;
    case'study':showPage('study');back.classList.add('visible');currentDeck=data.deck;currentSubdeck=data.subdeck||null;title.textContent=currentSubdeck?`${currentDeck} > ${currentSubdeck}`:currentDeck;studyFilter=LS.load('fc_studyFilter','all');studySort=LS.load('fc_studySort',null);if(!isGuest){showLoading();await loadDeckCards(currentDeck);document.getElementById('loading').classList.add('hidden')}startStudy();break;
    case'public-study':showPage('study');back.classList.add('visible');isPublicStudy=true;title.textContent=data.title;studyCards=data.cards;studyIndex=0;answerShown=false;document.getElementById('study-filters').innerHTML='';renderStudyCard();break;
    case'manage':showPage('manage');back.classList.add('visible');currentDeck=data;title.textContent=data+' - ç®¡ç†';manageSubdeckFilter='';manageSearch='';managePage=0;document.getElementById('manage-search').value='';if(!isGuest){showLoading();await loadDeckCards(currentDeck);document.getElementById('loading').classList.add('hidden')}resetForm();renderManageSubdecks();renderManageList();break;
    case'stats':showPage('stats');back.classList.add('visible');title.textContent='çµ±è¨ˆ';renderStats();break;
  }
}
document.getElementById('back-btn').addEventListener('click',()=>navigateTo('home'));
document.getElementById('stats-btn').addEventListener('click',()=>navigateTo('stats'));

/* ========== Home Tabs ========== */
function setHomeTab(tab){
  activeHomeTab=tab;
  document.querySelectorAll('.home-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.querySelectorAll('.home-section').forEach(s=>s.classList.remove('active'));
  const secId=tab==='my'?'section-my':tab==='chat'?'section-chat':'section-public';
  document.getElementById(secId).classList.add('active');
  if(tab==='public')loadPublicDecks();
}
document.querySelectorAll('.home-tab').forEach(t=>t.addEventListener('click',()=>setHomeTab(t.dataset.tab)));

/* ========== Helpers ========== */
function getDeck(n){return decks.find(d=>d.name===n)}
function deckCards(n){return cards.filter(c=>c.deck===n)}
function subdeckCards(n,s){return cards.filter(c=>c.deck===n&&c.subdeck===s)}
function countR(a,r){return a.filter(c=>c.lastRating===r).length}
function countU(a){return a.filter(c=>!c.lastRating).length}

/* ========== Home: My Decks ========== */
function renderDeckList(){
  const el=document.getElementById('deck-list');let html='';
  for(const d of decks){
    const total=d.cardCount||0,hasSD=d.subdecks&&d.subdecks.length>0,exp=expandedDecks.has(d.name);
    html+=`<div class="deck-card" data-deck="${esc(d.name)}">${hasSD?`<span class="deck-chevron">${exp?'â–¼':'â–¶'}</span>`:''}<span class="deck-card-name">${esc(d.name)}</span>${d.publishedId?'<span class="badge-public">å…¬é–‹ä¸­</span>':''}<span class="deck-count">${total}æš</span><button class="deck-manage-btn" data-act="manage" data-deck="${esc(d.name)}" title="ã‚«ãƒ¼ãƒ‰ç®¡ç†">&#x1f4cb;</button></div>`;
    if(hasSD&&exp){for(const sd of d.subdecks){html+=`<div class="subdeck-card" data-deck="${esc(d.name)}" data-subdeck="${esc(sd)}">${esc(sd)}</div>`}html+=`<div class="subdeck-card subdeck-study-all" data-deck="${esc(d.name)}" data-subdeck="">å…¨ä½“ã‚’å­¦ç¿’</div>`}
  }
  el.innerHTML=html;
  el.querySelectorAll('.deck-card').forEach(c=>{c.addEventListener('click',e=>{if(e.target.closest('[data-act="manage"]')){e.stopPropagation();navigateTo('manage',c.dataset.deck);return}const dk=getDeck(c.dataset.deck);if(dk&&dk.subdecks&&dk.subdecks.length>0){if(expandedDecks.has(dk.name))expandedDecks.delete(dk.name);else expandedDecks.add(dk.name);renderDeckList()}else{navigateTo('study',{deck:c.dataset.deck})}})});
  el.querySelectorAll('.subdeck-card').forEach(c=>{c.addEventListener('click',()=>{const sd=c.dataset.subdeck;if(sd)navigateTo('study',{deck:c.dataset.deck,subdeck:sd});else navigateTo('study',{deck:c.dataset.deck})})});
}

async function deleteDeckAction(name){
  if(!confirm(`ã€Œ${name}ã€ã¨ã‚«ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
  const delDeck=getDeck(name);
  if(isGuest){cards=cards.filter(c=>c.deck!==name);LS.save('fc_cards',cards)}
  else{const snap=await cardsCol().where('deck','==',name).get();const docs=snap.docs;for(let i=0;i<docs.length;i+=400){const batch=db.batch();docs.slice(i,i+400).forEach(d=>batch.delete(d.ref));await batch.commit()}}
  if(delDeck&&delDeck.publishedId){try{const old=await db.collection('publicDecks').doc(delDeck.publishedId).collection('cards').get();for(let i=0;i<old.docs.length;i+=400){const b=db.batch();old.docs.slice(i,i+400).forEach(d=>b.delete(d.ref));await b.commit()}await db.collection('publicDecks').doc(delDeck.publishedId).delete()}catch(e){console.error(e)}}
  decks=decks.filter(d=>d.name!==name);if(!decks.length)decks.push({name:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}});
  await saveDecks();renderDeckList();showToast(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
}

async function renameDeckAction(oldName){
  const newName=prompt('æ–°ã—ã„ãƒ‡ãƒƒã‚­åã‚’å…¥åŠ›:',oldName);
  if(!newName||newName.trim()===''||newName.trim()===oldName)return;
  const nn=newName.trim();
  if(getDeck(nn)){showToast('åŒã˜åå‰ã®ãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã™');return}
  const deck=getDeck(oldName);if(!deck)return;
  deck.name=nn;
  if(isGuest){for(const c of cards){if(c.deck===oldName)c.deck=nn}LS.save('fc_cards',cards)}
  else{const snap=await cardsCol().where('deck','==',oldName).get();const docs=snap.docs;for(let i=0;i<docs.length;i+=400){const batch=db.batch();docs.slice(i,i+400).forEach(d=>batch.update(d.ref,{deck:nn}));await batch.commit()}}
  await saveDecks();renderDeckList();showToast(`ã€Œ${nn}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
}

/* ========== Home: Public Decks ========== */
async function loadPublicDecks(){
  const el=document.getElementById('public-deck-list'),ld=document.getElementById('public-loading');
  ld.style.display='block';el.innerHTML='';
  try{
    const snap=await db.collection('publicDecks').orderBy('updatedAt','desc').get();
    ld.style.display='none';
    if(snap.empty){el.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#x1f4da;</div><p>å…¬é–‹ãƒ‡ãƒƒã‚­ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p></div>';return}
    const uid=currentUser?.uid||'';
    el.innerHTML=snap.docs.map(doc=>{const d=doc.data();const isMine=uid&&d.authorId===uid;return`<div class="pub-deck-card" data-id="${doc.id}"><div class="pub-deck-title">${esc(d.title)}</div><div class="pub-deck-meta"><span>${d.cardCount||0}æš</span><span>by ${esc(d.authorName||'åŒ¿å')}</span></div>${d.description?`<div class="pub-deck-desc">${esc(d.description)}</div>`:''}<div class="pub-deck-actions"><button class="btn btn-blue btn-sm" data-act="study" data-id="${doc.id}">å­¦ç¿’ã™ã‚‹</button>${(!isGuest&&currentUser)?`<button class="btn btn-outline btn-sm" data-act="copy" data-id="${doc.id}">ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>`:''}${isMine?`<button data-act="remove-pub" data-id="${doc.id}" style="background:none;border:none;font-size:1.2rem;cursor:pointer;padding:4px 6px;opacity:.5">&#x1f5d1;</button>`:''}</div></div>`}).join('');
    el.querySelectorAll('[data-act="study"]').forEach(b=>b.addEventListener('click',()=>studyPublicDeck(b.dataset.id)));
    el.querySelectorAll('[data-act="copy"]').forEach(b=>b.addEventListener('click',()=>copyPublicDeck(b.dataset.id)));
    el.querySelectorAll('[data-act="remove-pub"]').forEach(b=>b.addEventListener('click',()=>removePublicDeck(b.dataset.id)));
  }catch(e){ld.style.display='none';console.error(e);el.innerHTML='<div class="empty-state"><p>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>'}
}

async function studyPublicDeck(id){
  showLoading();
  try{
    const doc=await db.collection('publicDecks').doc(id).get();
    const snap=await db.collection('publicDecks').doc(id).collection('cards').orderBy('order').get();
    const pubCards=snap.docs.map((d,i)=>({question:d.data().question,answer:d.data().answer,detail:d.data().detail||'',subdeck:d.data().subdeck||'',order:i}));
    document.getElementById('loading').classList.add('hidden');
    if(!pubCards.length){showToast('ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');return}
    activeHomeTab='public';
    navigateTo('public-study',{title:doc.data().title,cards:pubCards});
  }catch(e){document.getElementById('loading').classList.add('hidden');console.error(e);showToast('èª­ã¿è¾¼ã¿å¤±æ•—')}
}

async function copyPublicDeck(id){
  if(isGuest||!currentUser){showToast('ã‚³ãƒ”ãƒ¼ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');return}
  if(!confirm('ã“ã®ãƒ‡ãƒƒã‚­ã‚’ãƒã‚¤ãƒ‡ãƒƒã‚­ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹ï¼Ÿ'))return;
  showLoading();
  try{
    const doc=await db.collection('publicDecks').doc(id).get();
    const d=doc.data();
    const deckName=d.title;
    let finalName=deckName;let cnt=1;while(getDeck(finalName)){finalName=`${deckName} (${cnt++})`}
    decks.push({name:finalName,subdecks:d.subdecks||[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}});
    const snap=await db.collection('publicDecks').doc(id).collection('cards').orderBy('order').get();
    const newCards=snap.docs.map(c=>{const cd=c.data();return{question:cd.question,answer:cd.answer,detail:cd.detail||'',deck:finalName,subdeck:cd.subdeck||'',lastRating:null,created:new Date().toISOString()}});
    for(let i=0;i<newCards.length;i+=400){const batch=db.batch();newCards.slice(i,i+400).forEach(c=>{const ref=cardsCol().doc();batch.set(ref,c)});await batch.commit()}
    const newDeck=getDeck(finalName);if(newDeck){newDeck.cardCount=newCards.length;newDeck.ratings={incorrect:0,correct:0,understood:0}}
    cards=[];await saveDecks();
    document.getElementById('loading').classList.add('hidden');
    showToast(`ã€Œ${finalName}ã€ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);setHomeTab('my');renderDeckList();
  }catch(e){document.getElementById('loading').classList.add('hidden');console.error(e);showToast('ã‚³ãƒ”ãƒ¼å¤±æ•—')}
}

async function removePublicDeck(id){
  if(!confirm('ã“ã®å…¬é–‹ãƒ‡ãƒƒã‚­ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  try{
    const old=await db.collection('publicDecks').doc(id).collection('cards').get();
    for(let i=0;i<old.docs.length;i+=400){const batch=db.batch();old.docs.slice(i,i+400).forEach(d=>batch.delete(d.ref));await batch.commit()}
    await db.collection('publicDecks').doc(id).delete();
    for(const dk of decks){if(dk.publishedId===id){dk.publishedId=null}}
    await saveDecks();
    showToast('å…¬é–‹ãƒ‡ãƒƒã‚­ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');loadPublicDecks();
  }catch(e){console.error(e);showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ')}
}

/* ========== Study ========== */
function getStudyPool(){
  let pool;if(currentSubdeck)pool=subdeckCards(currentDeck,currentSubdeck);else pool=deckCards(currentDeck);
  if(studyFilter!=='all'){if(studyFilter==='unrated')pool=pool.filter(c=>!c.lastRating);else pool=pool.filter(c=>c.lastRating===studyFilter)}
  if(studySort==='shuffle'){pool=[...pool];for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]]}}else if(studySort){const[field,dir]=studySort.split('-');const key=field==='incorrect'?'incorrectCount':'correctCount';pool=[...pool].sort((a,b)=>dir==='desc'?(b[key]||0)-(a[key]||0):(a[key]||0)-(b[key]||0))}
  return pool;
}
function startStudy(){renderStudyFilters();studyCards=getStudyPool();studyIndex=0;answerShown=false;renderStudyCard()}
function renderStudyFilters(){
  const sortEl=document.getElementById('study-sort');
  if(isPublicStudy){document.getElementById('study-filters').innerHTML='';sortEl.innerHTML='';return}
  const pool=currentSubdeck?subdeckCards(currentDeck,currentSubdeck):deckCards(currentDeck);
  const fs=[{key:'all',label:'å…¨',count:pool.length},{key:'unrated',label:'æœª',count:countU(pool)},{key:'incorrect',label:'Ã—',count:countR(pool,'incorrect')},{key:'correct',label:'â—¯',count:countR(pool,'correct')},{key:'understood',label:'&#x1f44d;',count:countR(pool,'understood')}];
  document.getElementById('study-filters').innerHTML=fs.map(f=>`<button class="study-filter-btn ${studyFilter===f.key?'active':''}" data-filter="${f.key}">${f.label}<span class="filter-count">${f.count}</span></button>`).join('');
  document.querySelectorAll('.study-filter-btn').forEach(b=>{b.addEventListener('click',()=>{studyFilter=b.dataset.filter;LS.save('fc_studyFilter',studyFilter);studyCards=getStudyPool();studyIndex=0;answerShown=false;renderStudyFilters();renderStudyCard()})});
  sortEl.innerHTML='<select id="study-sort-select"><option value="">ä¸¦ã³é †</option><option value="incorrect-desc">Ã— å¤šã„é †</option><option value="incorrect-asc">Ã— å°‘ãªã„é †</option><option value="correct-desc">â—¯ å¤šã„é †</option><option value="correct-asc">â—¯ å°‘ãªã„é †</option><option value="shuffle">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</option></select><button class="study-icon-btn" id="shuffle-btn" title="ã‚·ãƒ£ãƒƒãƒ•ãƒ«">&#x1f500;</button><button class="study-icon-btn" id="autoplay-btn" title="è‡ªå‹•å†ç”Ÿ">'+(isPlaying?'&#x25a0;':'&#x25b6;&#xfe0e;')+'</button>';
  document.getElementById('study-sort-select').value=studySort||'';
  document.getElementById('study-sort-select').addEventListener('change',e=>{studySort=e.target.value||null;LS.save('fc_studySort',studySort);studyCards=getStudyPool();studyIndex=0;answerShown=false;renderStudyCard()});
}
function renderStudyCard(){
  const qE=document.getElementById('anki-question'),aE=document.getElementById('anki-answer'),dv=document.getElementById('anki-divider'),rt=document.getElementById('anki-rating'),lb=document.getElementById('anki-label'),cs=document.getElementById('anki-card-stats');
  document.getElementById('study-deck-name').textContent=isPublicStudy?'':currentSubdeck?`${currentDeck} > ${currentSubdeck}`:currentDeck;
  const dtW=document.getElementById('anki-detail-wrap'),dtE=document.getElementById('anki-detail'),dtT=document.getElementById('anki-detail-toggle');
  if(!studyCards.length){qE.textContent='ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“';aE.style.display='none';dv.style.display='none';rt.style.display='none';cs.style.display='none';dtW.style.display='none';document.getElementById('study-progress-text').textContent='0 / 0';document.getElementById('study-progress-fill').style.width='0%';lb.textContent='';return}
  const card=studyCards[studyIndex];
  document.getElementById('study-progress-text').textContent=`${studyIndex+1} / ${studyCards.length}`;
  document.getElementById('study-progress-fill').style.width=`${((studyIndex+1)/studyCards.length)*100}%`;
  qE.textContent=card.question;aE.textContent=card.answer;
  const xc=card.incorrectCount||0,oc=card.correctCount||0;if(xc||oc){let m='';for(let i=0;i<xc;i++)m+='<span class="mark-x">Ã—</span>';for(let i=0;i<oc;i++)m+='<span class="mark-o">â—¯</span>';cs.innerHTML=m;cs.style.display='block'}else{cs.style.display='none'}
  rt.style.display='flex';
  if(answerShown){lb.textContent='å•é¡Œ + ç­”ãˆ';aE.style.display='block';dv.style.display='block';if(card.detail){dtW.style.display='block';dtE.textContent=card.detail;dtE.style.display='none';dtT.textContent='è©³ã—ã â–¼'}else{dtW.style.display='none'}}
  else{lb.textContent='å•é¡Œ';aE.style.display='none';dv.style.display='none';dtW.style.display='none'}
}

document.getElementById('anki-card').addEventListener('click',e=>{if(e.target.closest('#anki-detail-wrap'))return;if(studyCards.length>0){answerShown=!answerShown;renderStudyCard()}});
document.getElementById('anki-detail-toggle').addEventListener('click',()=>{const d=document.getElementById('anki-detail'),t=document.getElementById('anki-detail-toggle');if(d.style.display==='none'){d.style.display='block';t.textContent='é–‰ã˜ã‚‹ â–²'}else{d.style.display='none';t.textContent='è©³ã—ã â–¼'}});

document.querySelectorAll('.anki-rating-btn').forEach(b=>{b.addEventListener('click',async()=>{
  const r=b.dataset.rating;
  if(isPublicStudy){studyIndex=(studyIndex+1)%studyCards.length;answerShown=false;renderStudyCard();return}
  const card=studyCards[studyIndex];const oldRating=card.lastRating;stats.reviews++;stats[r]++;trackDaily(r,currentDeck);
  const upd={lastRating:r};if(r==='incorrect')upd.incorrectCount=(card.incorrectCount||0)+1;if(r==='correct')upd.correctCount=(card.correctCount||0)+1;
  await updateCard(card.id,upd);await saveStats();
  const dk=getDeck(currentDeck);if(dk&&dk.ratings){if(oldRating&&dk.ratings[oldRating]!=null)dk.ratings[oldRating]=Math.max(0,dk.ratings[oldRating]-1);dk.ratings[r]=(dk.ratings[r]||0)+1;saveDecks()}
  studyIndex=(studyIndex+1)%studyCards.length;answerShown=false;
  studyCards=getStudyPool();if(studyIndex>=studyCards.length)studyIndex=0;
  renderStudyFilters();
  if(isPlaying){if(playTimer)clearTimeout(playTimer);autoPlayNext()}else{renderStudyCard()}
})});

document.getElementById('study-sort').addEventListener('click',e=>{const sh=e.target.closest('#shuffle-btn');const ap=e.target.closest('#autoplay-btn');if(sh){studySort='shuffle';LS.save('fc_studySort',studySort);studyCards=getStudyPool();studyIndex=0;answerShown=false;const sel=document.getElementById('study-sort-select');if(sel)sel.value='shuffle';renderStudyCard();showToast('ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸ')}if(ap){if(isPlaying){stopAutoPlay()}else{if(!studyCards.length)return;isPlaying=true;ap.innerHTML='&#x25a0;';ap.classList.add('active');autoPlayNext()}}});
function stopAutoPlay(){isPlaying=false;if(playTimer)clearTimeout(playTimer);const ap=document.getElementById('autoplay-btn');if(ap){ap.innerHTML='&#x25b6;&#xfe0e;';ap.classList.remove('active')}}
function autoPlayNext(){if(!isPlaying)return;const qD=parseInt(document.getElementById('cfg-q-delay').value)*1000,aD=parseInt(document.getElementById('cfg-a-delay').value)*1000;answerShown=false;renderStudyCard();playTimer=setTimeout(()=>{if(!isPlaying)return;answerShown=true;renderStudyCard();playTimer=setTimeout(()=>{if(!isPlaying)return;if(!isPublicStudy){stats.reviews++;stats.correct++;trackDaily('correct',currentDeck);saveStats()}studyIndex=(studyIndex+1)%studyCards.length;autoPlayNext()},aD)},qD)}

/* ========== Manage ========== */
function renderPublishSection(){
  if(isGuest||!currentUser){document.getElementById('publish-section').style.display='none';return}
  document.getElementById('publish-section').style.display='block';
  const deck=getDeck(currentDeck);if(!deck)return;
  const st=document.getElementById('publish-status'),btns=document.getElementById('publish-buttons');
  if(deck.publishedId){
    st.className='publish-status published';st.textContent='&#x2705; ã“ã®ãƒ‡ãƒƒã‚­ã¯å…¬é–‹ä¸­ã§ã™';
    btns.innerHTML='<button class="btn btn-green btn-sm" id="publish-update-btn">æ›´æ–°ã™ã‚‹</button><button class="btn btn-red btn-sm" id="unpublish-btn">éå…¬é–‹ã«ã™ã‚‹</button>';
    document.getElementById('publish-update-btn').addEventListener('click',()=>publishDeck(true));
    document.getElementById('unpublish-btn').addEventListener('click',unpublishDeck);
  }else{
    st.className='publish-status';st.textContent='ã“ã®ãƒ‡ãƒƒã‚­ã¯å…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“';
    btns.innerHTML='<button class="btn btn-green btn-sm" id="publish-do-btn">å…¬é–‹ã™ã‚‹</button>';
    document.getElementById('publish-do-btn').addEventListener('click',()=>publishDeck(false));
  }
}

async function publishDeck(isUpdate){
  const deck=getDeck(currentDeck);if(!deck)return;
  const dc=deckCards(currentDeck);
  if(!dc.length){showToast('ã‚«ãƒ¼ãƒ‰ãŒãªã„ãƒ‡ãƒƒã‚­ã¯å…¬é–‹ã§ãã¾ã›ã‚“');return}
  const desc=document.getElementById('publish-desc').value.trim();
  const data={title:currentDeck,description:desc,authorId:currentUser.uid,authorName:currentUser.displayName||'åŒ¿å',cardCount:dc.length,subdecks:deck.subdecks||[],updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  try{
    let docId;
    if(isUpdate&&deck.publishedId){
      docId=deck.publishedId;
      await db.collection('publicDecks').doc(docId).update(data);
      // æ—¢å­˜ã‚«ãƒ¼ãƒ‰å‰Šé™¤
      const old=await db.collection('publicDecks').doc(docId).collection('cards').get();
      for(let i=0;i<old.docs.length;i+=400){const b=db.batch();old.docs.slice(i,i+400).forEach(d=>b.delete(d.ref));await b.commit()}
    }else{
      data.createdAt=firebase.firestore.FieldValue.serverTimestamp();
      const ref=await db.collection('publicDecks').add(data);docId=ref.id;
      deck.publishedId=docId;await saveDecks();
    }
    // ã‚«ãƒ¼ãƒ‰è¿½åŠ ï¼ˆãƒãƒƒãƒï¼‰
    let batch=db.batch(),cnt=0;
    for(let i=0;i<dc.length;i++){const c=dc[i];const ref=db.collection('publicDecks').doc(docId).collection('cards').doc();batch.set(ref,{question:c.question,answer:c.answer,detail:c.detail||'',subdeck:c.subdeck||'',order:i});cnt++;if(cnt>=400){await batch.commit();batch=db.batch();cnt=0}}
    if(cnt>0)await batch.commit();
    showToast(isUpdate?'å…¬é–‹ãƒ‡ãƒƒã‚­ã‚’æ›´æ–°ã—ã¾ã—ãŸ':'ãƒ‡ãƒƒã‚­ã‚’å…¬é–‹ã—ã¾ã—ãŸ');renderPublishSection();renderDeckList();
  }catch(e){console.error(e);showToast('å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ')}
}

async function unpublishDeck(){
  if(!confirm('ã“ã®ãƒ‡ãƒƒã‚­ã‚’éå…¬é–‹ã«ã—ã¾ã™ã‹ï¼Ÿ'))return;
  const deck=getDeck(currentDeck);if(!deck||!deck.publishedId)return;
  try{
    const old=await db.collection('publicDecks').doc(deck.publishedId).collection('cards').get();
    for(let i=0;i<old.docs.length;i+=400){const batch=db.batch();old.docs.slice(i,i+400).forEach(d=>batch.delete(d.ref));await batch.commit()}
    await db.collection('publicDecks').doc(deck.publishedId).delete();
    deck.publishedId=null;await saveDecks();
    showToast('éå…¬é–‹ã«ã—ã¾ã—ãŸ');renderPublishSection();renderDeckList();
  }catch(e){console.error(e);showToast('å¤±æ•—ã—ã¾ã—ãŸ')}
}

function renderManageSubdecks(){
  const deck=getDeck(currentDeck);if(!deck)return;
  const chips=document.getElementById('subdeck-chips');
  chips.innerHTML=deck.subdecks.map(sd=>`<div class="subdeck-chip">${esc(sd)}<span class="subdeck-chip-rename" data-sd="${esc(sd)}" title="åç§°å¤‰æ›´">&#x270f;</span><span class="subdeck-chip-del" data-sd="${esc(sd)}" title="å‰Šé™¤">&#x2715;</span></div>`).join('');
  chips.querySelectorAll('.subdeck-chip-rename').forEach(el=>{el.addEventListener('click',async()=>{const oldSd=el.dataset.sd;const newSd=prompt('æ–°ã—ã„ã‚µãƒ–ãƒ‡ãƒƒã‚­å:',oldSd);if(!newSd||newSd.trim()===''||newSd.trim()===oldSd)return;const nn=newSd.trim();if(deck.subdecks.includes(nn)){showToast('åŒã˜åå‰ã®ã‚µãƒ–ãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã™');return}const idx=deck.subdecks.indexOf(oldSd);if(idx!==-1)deck.subdecks[idx]=nn;if(isGuest){for(const c of cards){if(c.deck===currentDeck&&c.subdeck===oldSd)c.subdeck=nn}LS.save('fc_cards',cards)}else{const snap=await cardsCol().where('deck','==',currentDeck).where('subdeck','==',oldSd).get();const docs=snap.docs;for(let i=0;i<docs.length;i+=400){const batch=db.batch();docs.slice(i,i+400).forEach(d=>batch.update(d.ref,{subdeck:nn}));await batch.commit()}for(const c of cards){if(c.deck===currentDeck&&c.subdeck===oldSd)c.subdeck=nn}}await saveDecks();renderManageSubdecks();renderManageList();showToast(`ã€Œ${nn}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`)})});
  chips.querySelectorAll('.subdeck-chip-del').forEach(el=>{el.addEventListener('click',async()=>{const sd=el.dataset.sd;if(!confirm(`ã‚µãƒ–ãƒ‡ãƒƒã‚­ã€Œ${sd}ã€ã‚’å‰Šé™¤ï¼Ÿ`))return;for(const c of cards){if(c.deck===currentDeck&&c.subdeck===sd){c.subdeck='';if(!isGuest)await cardsCol().doc(c.id).update({subdeck:''})}}if(isGuest)LS.save('fc_cards',cards);deck.subdecks=deck.subdecks.filter(s=>s!==sd);await saveDecks();renderManageSubdecks();renderManageList()})});
  const sel=document.getElementById('card-subdeck-select');
  sel.innerHTML='<option value="">ãªã—ï¼ˆç›´ä¸‹ï¼‰</option>'+deck.subdecks.map(sd=>`<option value="${esc(sd)}">${esc(sd)}</option>`).join('');
  document.getElementById('subdeck-select-group').style.display=deck.subdecks.length?'block':'none';
}
document.getElementById('add-subdeck-btn').addEventListener('click',async()=>{const i=document.getElementById('new-subdeck-input'),n=i.value.trim(),dk=getDeck(currentDeck);if(n&&dk&&!dk.subdecks.includes(n)){dk.subdecks.push(n);await saveDecks();i.value='';renderManageSubdecks();renderManageList();showToast(`ã‚µãƒ–ãƒ‡ãƒƒã‚­ã€Œ${n}ã€ã‚’è¿½åŠ `)}});
document.getElementById('new-subdeck-input').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();document.getElementById('add-subdeck-btn').click()}});
document.getElementById('manage-search').addEventListener('input',e=>{manageSearch=e.target.value.trim().toLowerCase();managePage=0;renderManageList()});

function renderManageList(){
  try{
  const dc=deckCards(currentDeck);document.getElementById('manage-card-count').textContent=`ã‚«ãƒ¼ãƒ‰ (${dc.length}æš)`;
  const el=document.getElementById('manage-card-list');const fEl=document.getElementById('manage-subdeck-filter');const pgEl=document.getElementById('manage-pagination');
  const deck=getDeck(currentDeck),sds=deck?.subdecks||[];
  if(sds.length>0){fEl.innerHTML=`<select id="subdeck-filter-select" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:.85rem;background:#fff;color:#555"><option value="">å…¨ã¦</option>${sds.map(s=>`<option value="${esc(s)}"${manageSubdeckFilter===s?' selected':''}>${esc(s)}</option>`).join('')}</select>`;document.getElementById('subdeck-filter-select').addEventListener('change',e=>{manageSubdeckFilter=e.target.value;managePage=0;renderManageList()})}else{fEl.innerHTML=''}
  if(!dc.length){el.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#x1f4dd;</div><p>ã‚«ãƒ¼ãƒ‰ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p></div>';pgEl.innerHTML='';return}
  let filtered=manageSubdeckFilter?dc.filter(c=>c.subdeck===manageSubdeckFilter):dc;
  if(manageSearch){filtered=filtered.filter(c=>(c.question||'').toLowerCase().includes(manageSearch)||(c.answer||'').toLowerCase().includes(manageSearch))}
  if(!filtered.length){el.innerHTML='<div class="empty-state"><p>è©²å½“ã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';pgEl.innerHTML='';return}
  const totalPages=Math.ceil(filtered.length/MANAGE_PER_PAGE);if(managePage>=totalPages)managePage=totalPages-1;
  const pageItems=filtered.slice(managePage*MANAGE_PER_PAGE,(managePage+1)*MANAGE_PER_PAGE);
  el.innerHTML=pageItems.map(c=>{let tags='';if(c.subdeck)tags+=`<span class="card-item-tag tag-subdeck">${esc(c.subdeck)}</span>`;if(c.incorrectCount)tags+=`<span class="card-item-tag tag-incorrect">Ã— ${c.incorrectCount}</span>`;if(c.correctCount)tags+=`<span class="card-item-tag tag-correct">â—¯ ${c.correctCount}</span>`;return`<div class="card-item"><div class="card-item-content"><div class="card-item-q">${esc(c.question)}</div><div class="card-item-a">${esc(c.answer)}</div>${tags?`<div class="card-item-tags">${tags}</div>`:''}</div><div class="card-item-actions"><button class="card-item-btn" data-act="edit" data-id="${c.id}">&#x270f;</button><button class="card-item-btn" data-act="del" data-id="${c.id}">&#x1f5d1;</button></div></div>`}).join('');
  el.querySelectorAll('.card-item-btn').forEach(b=>{b.addEventListener('click',()=>{if(b.dataset.act==='edit')editCardAction(b.dataset.id);if(b.dataset.act==='del')deleteCardAction(b.dataset.id)})});
  if(totalPages>1){pgEl.innerHTML=`<button class="btn btn-outline btn-sm" id="pg-prev" ${managePage===0?'disabled':''}>&lt; å‰</button><span style="font-size:.85rem;color:#666">${managePage+1} / ${totalPages}</span><button class="btn btn-outline btn-sm" id="pg-next" ${managePage>=totalPages-1?'disabled':''}> æ¬¡ &gt;</button>`;document.getElementById('pg-prev').addEventListener('click',()=>{if(managePage>0){managePage--;renderManageList();document.getElementById('manage-card-count').scrollIntoView({behavior:'smooth'})}});document.getElementById('pg-next').addEventListener('click',()=>{if(managePage<totalPages-1){managePage++;renderManageList();document.getElementById('manage-card-count').scrollIntoView({behavior:'smooth'})}})}else{pgEl.innerHTML=''}
  }catch(e){console.error('renderManageList error:',e)}
}

document.getElementById('card-form').addEventListener('submit',async e=>{e.preventDefault();const q=document.getElementById('card-question').value.trim(),a=document.getElementById('card-answer').value.trim(),sd=document.getElementById('card-subdeck-select').value,dt=document.getElementById('card-detail').value.trim();if(!q||!a)return;if(editingId){await updateCard(editingId,{question:q,answer:a,subdeck:sd,detail:dt||''});resetForm();showToast('æ›´æ–°ã—ã¾ã—ãŸ')}else{await addCard({question:q,answer:a,detail:dt||'',deck:currentDeck,subdeck:sd,lastRating:null,created:new Date().toISOString()});showToast('è¿½åŠ ã—ã¾ã—ãŸ')}document.getElementById('card-question').value='';document.getElementById('card-answer').value='';document.getElementById('card-detail').value='';renderManageList()});
function editCardAction(id){const c=cards.find(x=>x.id===id);if(!c)return;editingId=id;document.getElementById('card-question').value=c.question;document.getElementById('card-answer').value=c.answer;document.getElementById('card-detail').value=c.detail||'';document.getElementById('card-subdeck-select').value=c.subdeck||'';document.getElementById('manage-form-title').textContent='ã‚«ãƒ¼ãƒ‰ã‚’ç·¨é›†';document.getElementById('card-submit-btn').textContent='æ›´æ–°';document.getElementById('card-cancel-btn').style.display='block';document.getElementById('card-question').scrollIntoView({behavior:'smooth'})}
async function deleteCardAction(id){if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;await removeCard(id);renderManageList();showToast('å‰Šé™¤ã—ã¾ã—ãŸ')}
function resetForm(){editingId=null;document.getElementById('card-question').value='';document.getElementById('card-answer').value='';document.getElementById('card-detail').value='';document.getElementById('manage-form-title').textContent='ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ';document.getElementById('card-submit-btn').textContent='è¿½åŠ ';document.getElementById('card-cancel-btn').style.display='none'}
document.getElementById('card-cancel-btn').addEventListener('click',resetForm);

/* ========== Stats ========== */
function renderStats(){
  const sel=document.getElementById('stats-deck-filter');sel.innerHTML='<option value="">å…¨ã¦ã®ãƒ‡ãƒƒã‚­</option>'+decks.map(d=>`<option value="${esc(d.name)}"${statsFilterDeck===d.name?' selected':''}>${esc(d.name)}</option>`).join('');
  if(statsFilterDeck){
    const dk=getDeck(statsFilterDeck);
    document.getElementById('s-correct').textContent=dk?.ratings?.correct||0;
    document.getElementById('s-incorrect').textContent=dk?.ratings?.incorrect||0;
    document.getElementById('s-understood').textContent=dk?.ratings?.understood||0;
    let tr=0,sd=0;for(const[k,v]of Object.entries(dailyStats)){const dr=v.decks?.[statsFilterDeck]?.reviews||0;if(dr>0){tr+=dr;sd++}}
    document.getElementById('s-total-reviews').textContent=tr;document.getElementById('s-study-days').textContent=sd;
  }else{
    let ic=0,cc=0,uc=0;for(const d of decks){ic+=(d.ratings?.incorrect||0);cc+=(d.ratings?.correct||0);uc+=(d.ratings?.understood||0)}
    document.getElementById('s-correct').textContent=cc;document.getElementById('s-incorrect').textContent=ic;document.getElementById('s-understood').textContent=uc;
    document.getElementById('s-total-reviews').textContent=stats.reviews;document.getElementById('s-study-days').textContent=Object.keys(dailyStats).length;
  }
  renderStatsChart()}
function dateStr(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function getDailyReviews(k){const e=dailyStats[k];if(!e)return 0;if(statsFilterDeck)return e.decks?.[statsFilterDeck]?.reviews||0;return e.reviews||0}
function renderStatsChart(){
  const ctx=document.getElementById('stats-chart');if(!ctx)return;
  let labels=[],data=[],dayInfo=[];const now=new Date();
  if(statsRange==='day'){for(let i=13;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i);const k=dateStr(d);const dow=d.getDay();labels.push(`${d.getMonth()+1}/${d.getDate()}`);dayInfo.push(dow);data.push(getDailyReviews(k))}}
  else if(statsRange==='week'){for(let i=11;i>=0;i--){const wEnd=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i*7);const wSt=new Date(wEnd.getFullYear(),wEnd.getMonth(),wEnd.getDate()-6);let t=0;for(let j=0;j<7;j++){const d=new Date(wSt.getFullYear(),wSt.getMonth(),wSt.getDate()+j);t+=getDailyReviews(dateStr(d))}labels.push(`${wSt.getMonth()+1}/${wSt.getDate()}~`);dayInfo.push(-1);data.push(t)}}
  else{for(let i=11;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);const y=d.getFullYear(),m=d.getMonth();let t=0;for(const k of Object.keys(dailyStats)){const kd=new Date(k+'T00:00:00');if(kd.getFullYear()===y&&kd.getMonth()===m)t+=getDailyReviews(k)}labels.push(`${m+1}æœˆ`);dayInfo.push(-1);data.push(t)}}
  if(statsChart)statsChart.destroy();
  statsChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'å­¦ç¿’æ•°',data,borderColor:'#2196f3',backgroundColor:'rgba(33,150,243,0.1)',fill:true,tension:0.3,pointRadius:4,pointBackgroundColor:'#2196f3'}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:c=>{const dow=dayInfo[c.index];if(dow===0)return'#e53935';if(dow===6)return'#1565c0';return'#666'},font:{size:11}}},y:{beginAtZero:true,ticks:{precision:0}}}}})
}
document.querySelectorAll('.stats-range-btn').forEach(b=>{b.addEventListener('click',()=>{statsRange=b.dataset.range;document.querySelectorAll('.stats-range-btn').forEach(x=>x.classList.toggle('active',x===b));renderStatsChart()})});
document.getElementById('stats-deck-filter').addEventListener('change',e=>{statsFilterDeck=e.target.value;renderStats()});
document.getElementById('reset-stats-btn').addEventListener('click',async()=>{if(!confirm('çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆï¼Ÿ'))return;stats={reviews:0,incorrect:0,correct:0,understood:0};dailyStats={};await saveStats();showToast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');document.getElementById('settings-modal').classList.remove('active')});

/* ========== Settings ========== */
document.getElementById('settings-btn').addEventListener('click',()=>{if(currentPage==='manage'){renderManageSubdecks();renderPublishSection();document.getElementById('manage-settings-modal').classList.add('active')}else{document.getElementById('add-deck-modal-section').style.display='none';document.getElementById('deck-ops-section').style.display='none';document.getElementById('csv-import-section').style.display='none';document.getElementById('autoplay-settings-section').style.display='none';document.getElementById('howto-section').style.display='none';document.getElementById('reset-group-section').style.display='none';document.getElementById('settings-modal').classList.add('active')}});
document.getElementById('settings-close').addEventListener('click',()=>document.getElementById('settings-modal').classList.remove('active'));
document.getElementById('settings-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('active')});
document.getElementById('add-deck-modal-row').addEventListener('click',()=>{const s=document.getElementById('add-deck-modal-section');s.style.display=s.style.display==='none'?'block':'none'});
document.getElementById('settings-add-deck-btn').addEventListener('click',async()=>{const i=document.getElementById('settings-deck-input'),n=i.value.trim();if(!n){return}if(getDeck(n)){showToast('åŒã˜åå‰ã®ãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã™');return}decks.push({name:n,subdecks:[],publishedId:null,cardCount:0,ratings:{incorrect:0,correct:0,understood:0}});await saveDecks();i.value='';renderDeckList();showToast(`ã€Œ${n}ã€ã‚’è¿½åŠ `);document.getElementById('settings-modal').classList.remove('active')});
document.getElementById('settings-deck-input').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();document.getElementById('settings-add-deck-btn').click()}});
document.getElementById('deck-ops-row').addEventListener('click',()=>{const s=document.getElementById('deck-ops-section');if(s.style.display==='none'){s.style.display='block';document.getElementById('deck-ops-select').innerHTML=decks.map(d=>`<option value="${esc(d.name)}">${esc(d.name)}</option>`).join('')}else{s.style.display='none'}});
document.getElementById('deck-edit-btn').addEventListener('click',()=>{const name=document.getElementById('deck-ops-select').value;if(name){document.getElementById('settings-modal').classList.remove('active');navigateTo('manage',name)}});
document.getElementById('deck-rename-btn').addEventListener('click',()=>{const name=document.getElementById('deck-ops-select').value;if(name){document.getElementById('settings-modal').classList.remove('active');renameDeckAction(name)}});
document.getElementById('deck-delete-btn').addEventListener('click',async()=>{const name=document.getElementById('deck-ops-select').value;if(name){document.getElementById('settings-modal').classList.remove('active');await deleteDeckAction(name)}});
document.getElementById('autoplay-settings-row').addEventListener('click',()=>{const s=document.getElementById('autoplay-settings-section');s.style.display=s.style.display==='none'?'block':'none'});
document.getElementById('reset-group-row').addEventListener('click',()=>{const s=document.getElementById('reset-group-section');s.style.display=s.style.display==='none'?'block':'none'});
document.getElementById('howto-row').addEventListener('click',()=>{const s=document.getElementById('howto-section');s.style.display=s.style.display==='none'?'block':'none'});
function updateCsvSubdecks(){const dk=getDeck(document.getElementById('csv-import-deck').value);const sds=dk?.subdecks||[];document.getElementById('csv-import-subdeck').innerHTML='<option value="">ãªã—ï¼ˆç›´ä¸‹ï¼‰</option>'+sds.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('')}
document.getElementById('csv-import-row').addEventListener('click',()=>{const s=document.getElementById('csv-import-section');if(s.style.display==='none'){s.style.display='block';document.getElementById('csv-import-deck').innerHTML=decks.map(d=>`<option value="${esc(d.name)}">${esc(d.name)}</option>`).join('');updateCsvSubdecks()}else{s.style.display='none'}});
document.getElementById('csv-import-deck').addEventListener('change',updateCsvSubdecks);
document.getElementById('csv-file').addEventListener('change',async e=>{const f=e.target.files[0];if(!f)return;const dn=document.getElementById('csv-import-deck').value,sd=document.getElementById('csv-import-subdeck').value;if(!dn){showToast('ãƒ‡ãƒƒã‚­ã‚’é¸æŠã—ã¦ãã ã•ã„');return}document.getElementById('settings-modal').classList.remove('active');showLoading();try{const text=await f.text();const lines=text.split(/\r?\n/).filter(l=>l.trim());const newCards=[];for(const line of lines){const p=parseCSVLine(line);if(p.length>=2&&p[0].trim()&&p[1].trim()){newCards.push({question:p[0].trim(),answer:p[1].trim(),detail:(p[2]||'').trim(),deck:dn,subdeck:sd,lastRating:null,created:new Date().toISOString()})}}if(newCards.length){if(isGuest){for(const c of newCards){c.id=Date.now().toString()+Math.random();cards.push(c)}LS.save('fc_cards',cards)}else{for(let i=0;i<newCards.length;i+=400){const batch=db.batch();newCards.slice(i,i+400).forEach(c=>{const ref=cardsCol().doc();batch.set(ref,c)});await batch.commit()}}const dk=getDeck(dn);if(dk)dk.cardCount=(dk.cardCount||0)+newCards.length;if(!isGuest)cards=[];await saveDecks();renderDeckList()}showToast(`${newCards.length}å•ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`)}catch(err){console.error(err);showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—')}document.getElementById('loading').classList.add('hidden');e.target.value=''});
document.getElementById('reset-card-stats-row').addEventListener('click',async()=>{if(!confirm('å…¨ã‚«ãƒ¼ãƒ‰ã®â—¯Ã—ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ'))return;if(isGuest){for(const c of cards){c.incorrectCount=0;c.correctCount=0;c.lastRating=null}LS.save('fc_cards',cards)}else{const snap=await cardsCol().get();const docs=snap.docs;for(let i=0;i<docs.length;i+=400){const batch=db.batch();docs.slice(i,i+400).forEach(d=>batch.update(d.ref,{incorrectCount:0,correctCount:0,lastRating:null}));await batch.commit()}}for(const dk of decks){dk.ratings={incorrect:0,correct:0,understood:0}}await saveDecks();showToast('ã‚«ãƒ¼ãƒ‰çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');document.getElementById('settings-modal').classList.remove('active')});
document.getElementById('manage-settings-close').addEventListener('click',()=>document.getElementById('manage-settings-modal').classList.remove('active'));
document.getElementById('manage-settings-modal').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('active')});

/* ========== Claude Chat ========== */
let chatHistory=[];
function addChatMsg(role,content){
  const el=document.getElementById('chat-messages');
  const d=document.createElement('div');
  d.className='chat-message '+role;
  const avatar=role==='user'?'ğŸ‘¤':'ğŸ¤–';
  let html=content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  html=html.replace(/```(\w*)\n?([\s\S]*?)```/g,'<pre><code>$2</code></pre>');
  html=html.replace(/`([^`]+)`/g,'<code>$1</code>');
  html=html.replace(/\n/g,'<br>');
  d.innerHTML=`<div class="chat-avatar">${avatar}</div><div class="chat-bubble">${html}</div>`;
  el.appendChild(d);
  el.scrollTop=el.scrollHeight;
}
function showChatLoading(){
  const el=document.getElementById('chat-messages');
  const d=document.createElement('div');
  d.className='chat-message assistant';d.id='chat-loading';
  d.innerHTML='<div class="chat-avatar">ğŸ¤–</div><div class="chat-bubble chat-loading"><span></span><span></span><span></span></div>';
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}
function removeChatLoading(){const e=document.getElementById('chat-loading');if(e)e.remove()}
async function sendChat(){
  const input=document.getElementById('chat-input');
  const btn=document.getElementById('chat-send-btn');
  const msg=input.value.trim();
  if(!msg)return;
  input.value='';btn.disabled=true;
  addChatMsg('user',msg);
  chatHistory.push({role:'user',content:msg});
  showChatLoading();
  try{
    const res=await fetch('https://chatwithclaude-ydgcevv45q-uc.a.run.app',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({messages:chatHistory,userId:currentUser?currentUser.uid:null})
    });
    const data=await res.json();
    removeChatLoading();
    if(data.content&&data.content[0]){
      const text=data.content[0].text;
      chatHistory.push({role:'assistant',content:text});
      addChatMsg('assistant',text);
    }else{
      addChatMsg('assistant','ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  }catch(e){
    removeChatLoading();
    addChatMsg('assistant','é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
  }
  btn.disabled=false;input.focus();
}
document.getElementById('chat-send-btn').addEventListener('click',sendChat);
document.getElementById('chat-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat()}
});

/* ========== Util ========== */
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function showToast(m){const e=document.getElementById('toast');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2500)}
function parseCSVLine(line){const r=[];let c='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(q){if(ch==='"'&&line[i+1]==='"'){c+='"';i++}else if(ch==='"'){q=false}else{c+=ch}}else{if(ch==='"'){q=true}else if(ch===','){r.push(c);c=''}else{c+=ch}}}r.push(c);return r}
if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js')}
</script>
</body>
</html>
