<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>フラッシュカード学習</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: #f0f0f0;
      min-height: 100vh;
      color: #333;
    }

    /* ===== ページ共通 ===== */
    .page {
      display: none;
      max-width: 600px;
      margin: 0 auto;
      padding: 0 16px 40px;
      animation: fadeIn 0.25s ease;
    }
    .page.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ===== ヘッダー ===== */
    .app-header {
      background: #fff;
      border-bottom: 1px solid #ddd;
      padding: 14px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .app-header h1 {
      font-size: 1.1rem;
      font-weight: 700;
      flex: 1;
    }
    .header-back {
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      color: #2196f3;
      padding: 4px 8px;
      display: none;
    }
    .header-back.visible { display: block; }
    .header-actions {
      display: flex;
      gap: 8px;
    }
    .header-icon-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      color: #555;
    }
    .header-icon-btn:hover { background: #eee; }

    /* ===== ホーム: デッキ一覧 ===== */
    .deck-list { display: flex; flex-direction: column; gap: 8px; }

    .deck-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.15s;
      border: 1px solid #e0e0e0;
    }
    .deck-card:hover {
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }
    .deck-card:active { transform: scale(0.99); }

    .deck-info h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .deck-meta {
      font-size: 0.8rem;
      color: #888;
      display: flex;
      gap: 12px;
    }
    .deck-arrow { color: #bbb; font-size: 1.2rem; }

    .deck-card-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .deck-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      padding: 6px;
      border-radius: 6px;
      color: #999;
    }
    .deck-action-btn:hover { background: #f5f5f5; color: #555; }

    /* 新規デッキ追加 */
    .add-deck-section {
      margin-top: 16px;
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      border: 2px dashed #ccc;
    }
    .add-deck-section h3 {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 12px;
    }
    .add-deck-row {
      display: flex;
      gap: 8px;
    }
    .add-deck-row input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fafafa;
    }
    .add-deck-row input:focus { outline: none; border-color: #2196f3; }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    .btn:active { transform: scale(0.97); }
    .btn-blue { background: #2196f3; color: #fff; }
    .btn-blue:hover { background: #1976d2; }
    .btn-gray { background: #e0e0e0; color: #555; }
    .btn-gray:hover { background: #d0d0d0; }
    .btn-red { background: #ef5350; color: #fff; }
    .btn-red:hover { background: #d32f2f; }
    .btn-green { background: #4caf50; color: #fff; }
    .btn-green:hover { background: #388e3c; }
    .btn-orange { background: #ff9800; color: #fff; }
    .btn-orange:hover { background: #f57c00; }

    /* インポート / エクスポート */
    .io-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: center;
    }
    .io-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      color: #555;
    }
    .io-btn:hover { background: #f5f5f5; }

    /* ===== 学習ページ ===== */
    .study-header {
      text-align: center;
      margin-bottom: 8px;
    }
    .study-deck-name {
      font-size: 0.85rem;
      color: #888;
    }
    .study-progress {
      font-size: 0.85rem;
      color: #666;
      text-align: center;
      margin-bottom: 16px;
    }
    .study-progress-bar {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }
    .study-progress-fill {
      height: 100%;
      background: #4caf50;
      border-radius: 2px;
      transition: width 0.3s;
    }

    /* Ankiスタイルカード */
    .anki-card {
      background: #fff;
      border-radius: 12px;
      min-height: 280px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 32px 24px;
      text-align: center;
      font-size: 1.15rem;
      line-height: 1.8;
      cursor: pointer;
      border: 1px solid #e0e0e0;
      position: relative;
      user-select: none;
    }
    .anki-card-label {
      position: absolute;
      top: 12px;
      left: 16px;
      font-size: 0.75rem;
      color: #aaa;
      font-weight: 600;
      text-transform: uppercase;
    }
    .anki-card-text {
      white-space: pre-wrap;
      word-break: break-word;
    }
    .anki-divider {
      width: 80%;
      border: none;
      border-top: 1px solid #e0e0e0;
      margin: 20px 0;
    }
    .anki-answer-section {
      color: #1565c0;
    }

    /* 答え表示ボタン */
    .show-answer-btn {
      display: block;
      width: 100%;
      padding: 16px;
      margin-top: 20px;
      background: #e0e0e0;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      color: #555;
      font-weight: 500;
    }
    .show-answer-btn:hover { background: #d5d5d5; }

    /* Anki評価ボタン */
    .anki-rating {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    .anki-rating-btn {
      flex: 1;
      padding: 14px 8px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      color: #fff;
      font-weight: 600;
      transition: all 0.15s;
    }
    .anki-rating-btn:active { transform: scale(0.96); }
    .anki-rating-btn.again { background: #d32f2f; }
    .anki-rating-btn.again:hover { background: #b71c1c; }
    .anki-rating-btn.good { background: #4caf50; }
    .anki-rating-btn.good:hover { background: #388e3c; }
    .anki-rating-btn.easy { background: #2196f3; }
    .anki-rating-btn.easy:hover { background: #1565c0; }

    .anki-rating-label {
      display: block;
      font-size: 0.7rem;
      opacity: 0.8;
      margin-top: 2px;
      font-weight: 400;
    }

    /* 学習コントロール */
    .study-controls {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      justify-content: center;
    }
    .study-ctrl-btn {
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      color: #555;
    }
    .study-ctrl-btn:hover { background: #f5f5f5; }
    .study-ctrl-btn.active { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }

    /* 自動再生バー */
    .autoplay-bar {
      background: #fff3e0;
      border-radius: 8px;
      padding: 10px 16px;
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.85rem;
      color: #e65100;
    }
    .autoplay-bar.hidden { display: none; }
    .autoplay-stop {
      padding: 4px 12px;
      border: 1px solid #e65100;
      border-radius: 6px;
      background: none;
      color: #e65100;
      cursor: pointer;
      font-size: 0.8rem;
    }

    /* ===== カード管理ページ ===== */
    .manage-form {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      margin-bottom: 16px;
    }
    .manage-form h3 {
      font-size: 0.95rem;
      margin-bottom: 16px;
      color: #555;
    }
    .form-group { margin-bottom: 14px; }
    .form-group label {
      display: block;
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fafafa;
      color: #333;
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2196f3;
      background: #fff;
    }
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.6;
    }

    .card-list-section {
      margin-top: 20px;
    }
    .card-list-section h3 {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 12px;
    }
    .card-item {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .card-item-content { flex: 1; overflow: hidden; }
    .card-item-q {
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .card-item-a {
      font-size: 0.8rem;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-item-actions {
      display: flex;
      gap: 4px;
    }
    .card-item-btn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.95rem;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .card-item-btn:hover { background: #f0f0f0; }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #aaa;
    }
    .empty-state-icon { font-size: 3rem; margin-bottom: 12px; }

    /* ===== 統計ページ ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #2196f3;
    }
    .stat-label {
      font-size: 0.8rem;
      color: #999;
      margin-top: 4px;
    }

    /* ===== 設定モーダル ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 100;
      justify-content: center;
      align-items: flex-end;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #fff;
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 600px;
      padding: 24px 20px;
      max-height: 70vh;
      overflow-y: auto;
      animation: slideUp 0.25s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to   { transform: translateY(0); }
    }
    .modal h3 {
      font-size: 1rem;
      margin-bottom: 16px;
    }
    .modal-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.9rem;
    }
    .modal-row:last-child { border-bottom: none; }
    .modal-row input[type="number"] {
      width: 60px;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 6px;
      text-align: center;
      font-size: 0.9rem;
    }
    .modal-close {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 16px;
      background: #e0e0e0;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
    }

    /* レスポンシブ */
    @media (max-width: 600px) {
      .anki-card { min-height: 220px; padding: 24px 16px; font-size: 1rem; }
      .anki-rating { flex-direction: column; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

  <!-- ヘッダー -->
  <div class="app-header">
    <button class="header-back" id="back-btn" onclick="navigateTo('home')">&#8592;</button>
    <h1 id="header-title">デッキ</h1>
    <div class="header-actions">
      <button class="header-icon-btn" id="stats-btn" title="統計">&#x1f4ca;</button>
      <button class="header-icon-btn" id="settings-btn" title="設定">&#x2699;</button>
    </div>
  </div>

  <!-- ===== ホームページ: デッキ一覧 ===== -->
  <div class="page active" id="page-home">
    <div class="deck-list" id="deck-list"></div>

    <div class="add-deck-section">
      <h3>+ 新しいデッキを追加</h3>
      <div class="add-deck-row">
        <input type="text" id="new-deck-input" placeholder="デッキ名を入力">
        <button class="btn btn-blue" id="add-deck-btn">追加</button>
      </div>
    </div>

    <div class="io-row">
      <button class="io-btn" id="export-btn">&#x1f4e4; エクスポート</button>
      <button class="io-btn" id="import-btn">&#x1f4e5; インポート</button>
      <input type="file" id="import-file" accept=".json" style="display:none;">
    </div>
  </div>

  <!-- ===== 学習ページ ===== -->
  <div class="page" id="page-study">
    <div class="study-header">
      <div class="study-deck-name" id="study-deck-name"></div>
    </div>
    <div class="study-progress" id="study-progress">
      <span id="study-progress-text">0 / 0</span>
      <div class="study-progress-bar">
        <div class="study-progress-fill" id="study-progress-fill" style="width:0%"></div>
      </div>
    </div>

    <div class="anki-card" id="anki-card">
      <span class="anki-card-label" id="anki-label">問題</span>
      <div class="anki-card-text" id="anki-question"></div>
      <hr class="anki-divider" id="anki-divider" style="display:none">
      <div class="anki-card-text anki-answer-section" id="anki-answer" style="display:none"></div>
    </div>

    <button class="show-answer-btn" id="show-answer-btn">答えを表示</button>

    <div class="anki-rating" id="anki-rating" style="display:none">
      <button class="anki-rating-btn again" data-rating="hard">もう一回<span class="anki-rating-label">&lt;1分</span></button>
      <button class="anki-rating-btn good" data-rating="good">普通<span class="anki-rating-label">&lt;10分</span></button>
      <button class="anki-rating-btn easy" data-rating="easy">簡単<span class="anki-rating-label">4日</span></button>
    </div>

    <div class="study-controls">
      <button class="study-ctrl-btn" id="shuffle-btn">&#x1f500; シャッフル</button>
      <button class="study-ctrl-btn" id="autoplay-btn">&#x25b6; 自動再生</button>
    </div>

    <div class="autoplay-bar hidden" id="autoplay-bar">
      <span id="autoplay-status">自動再生中...</span>
      <button class="autoplay-stop" id="autoplay-stop">停止</button>
    </div>
  </div>

  <!-- ===== カード管理ページ ===== -->
  <div class="page" id="page-manage">
    <div class="manage-form">
      <h3 id="manage-form-title">カードを追加</h3>
      <form id="card-form">
        <div class="form-group">
          <label>問題（表面）</label>
          <textarea id="card-question" placeholder="問題を入力"></textarea>
        </div>
        <div class="form-group">
          <label>答え（裏面）</label>
          <textarea id="card-answer" placeholder="答えを入力"></textarea>
        </div>
        <div style="display:flex; gap:8px;">
          <button type="submit" class="btn btn-blue" style="flex:1" id="card-submit-btn">追加</button>
          <button type="button" class="btn btn-gray" id="card-cancel-btn" style="display:none">キャンセル</button>
        </div>
      </form>
    </div>

    <div class="card-list-section">
      <h3 id="manage-card-count">カード (0枚)</h3>
      <div id="manage-card-list"></div>
    </div>
  </div>

  <!-- ===== 統計ページ ===== -->
  <div class="page" id="page-stats">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="s-total-cards">0</div>
        <div class="stat-label">総カード数</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="s-total-reviews">0</div>
        <div class="stat-label">総復習回数</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="s-easy">0</div>
        <div class="stat-label">簡単</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="s-good">0</div>
        <div class="stat-label">普通</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="s-hard">0</div>
        <div class="stat-label">もう一回</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="s-decks">0</div>
        <div class="stat-label">デッキ数</div>
      </div>
    </div>
    <button class="btn btn-red" style="width:100%;" id="reset-stats-btn">統計をリセット</button>
  </div>

  <!-- ===== 設定モーダル ===== -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal">
      <h3>&#x2699; 設定</h3>
      <div class="modal-row">
        <span>自動再生: 問題表示（秒）</span>
        <input type="number" id="cfg-q-delay" value="3" min="1" max="30">
      </div>
      <div class="modal-row">
        <span>自動再生: 答え表示（秒）</span>
        <input type="number" id="cfg-a-delay" value="3" min="1" max="30">
      </div>
      <button class="modal-close" id="settings-close">閉じる</button>
    </div>
  </div>

  <script>
    /* ========== Storage ========== */
    const S = {
      K: { CARDS: 'fc_cards', DECKS: 'fc_decks', STATS: 'fc_stats' },
      load(k, d) { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } },
      save(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
    };

    /* ========== State ========== */
    let cards = S.load(S.K.CARDS, []);
    let decks = S.load(S.K.DECKS, ['デフォルト']);
    let stats = S.load(S.K.STATS, { reviews: 0, easy: 0, good: 0, hard: 0 });

    let currentDeck = null;
    let studyCards = [];
    let studyIndex = 0;
    let answerShown = false;
    let isPlaying = false;
    let playTimer = null;
    let editingId = null;

    // サンプルデータ（初回のみ）
    if (cards.length === 0) {
      cards = [
        { id: '1', question: '民法第1条の3つの基本原則は？', answer: '①公共の福祉適合の原則\n②信義誠実の原則\n③権利濫用禁止の原則', deck: 'デフォルト', created: new Date().toISOString() },
        { id: '2', question: '憲法第9条の内容は？', answer: '第1項：戦争の放棄\n第2項：戦力の不保持、交戦権の否認', deck: 'デフォルト', created: new Date().toISOString() },
        { id: '3', question: '判例：最大判昭和48年4月4日（尊属殺重罰規定違憲判決）のポイントは？', answer: '刑法200条（尊属殺人罪）は、法の下の平等（憲法14条1項）に違反し無効。\n※差別的取扱いの合理性を欠くと判断された。', deck: 'デフォルト', created: new Date().toISOString() }
      ];
      S.save(S.K.CARDS, cards);
    }

    /* ========== Navigation ========== */
    function navigateTo(page, data) {
      stopAutoPlay();
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('header-title');

      switch (page) {
        case 'home':
          document.getElementById('page-home').classList.add('active');
          backBtn.classList.remove('visible');
          title.textContent = 'デッキ';
          renderDeckList();
          break;

        case 'study':
          document.getElementById('page-study').classList.add('active');
          backBtn.classList.add('visible');
          currentDeck = data;
          title.textContent = data;
          startStudy();
          break;

        case 'manage':
          document.getElementById('page-manage').classList.add('active');
          backBtn.classList.add('visible');
          currentDeck = data;
          title.textContent = data + ' - 管理';
          resetForm();
          renderManageList();
          break;

        case 'stats':
          document.getElementById('page-stats').classList.add('active');
          backBtn.classList.add('visible');
          title.textContent = '統計';
          renderStats();
          break;
      }
    }

    /* ========== Home: Deck List ========== */
    function renderDeckList() {
      const container = document.getElementById('deck-list');
      container.innerHTML = decks.map(d => {
        const count = cards.filter(c => c.deck === d).length;
        return `
          <div class="deck-card" data-deck="${esc(d)}">
            <div class="deck-info" data-deck="${esc(d)}">
              <h3>${esc(d)}</h3>
              <div class="deck-meta">
                <span>${count}枚</span>
              </div>
            </div>
            <div class="deck-card-actions">
              <button class="deck-action-btn" data-action="manage" data-deck="${esc(d)}" title="カード管理">&#x270f;</button>
              ${d !== 'デフォルト' ? `<button class="deck-action-btn" data-action="delete" data-deck="${esc(d)}" title="削除">&#x1f5d1;</button>` : ''}
              <span class="deck-arrow" data-deck="${esc(d)}">&#x276f;</span>
            </div>
          </div>
        `;
      }).join('');

      // デッキカードのクリック
      container.querySelectorAll('.deck-card').forEach(el => {
        el.addEventListener('click', (e) => {
          const target = e.target.closest('[data-action]');
          const deckName = el.dataset.deck;
          if (target) {
            e.stopPropagation();
            if (target.dataset.action === 'manage') navigateTo('manage', deckName);
            if (target.dataset.action === 'delete') deleteDeck(deckName);
          } else {
            navigateTo('study', deckName);
          }
        });
      });
    }

    // デッキ追加
    document.getElementById('add-deck-btn').addEventListener('click', () => {
      const input = document.getElementById('new-deck-input');
      const name = input.value.trim();
      if (name && !decks.includes(name)) {
        decks.push(name);
        S.save(S.K.DECKS, decks);
        input.value = '';
        renderDeckList();
      }
    });
    document.getElementById('new-deck-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); document.getElementById('add-deck-btn').click(); }
    });

    // デッキ削除
    function deleteDeck(name) {
      if (!confirm(`「${name}」を削除しますか？\nカードはデフォルトに移動します。`)) return;
      cards.forEach(c => { if (c.deck === name) c.deck = 'デフォルト'; });
      decks = decks.filter(d => d !== name);
      S.save(S.K.DECKS, decks);
      S.save(S.K.CARDS, cards);
      renderDeckList();
    }

    /* ========== Study ========== */
    function startStudy() {
      studyCards = cards.filter(c => c.deck === currentDeck);
      studyIndex = 0;
      answerShown = false;
      renderStudyCard();
    }

    function renderStudyCard() {
      const qEl = document.getElementById('anki-question');
      const aEl = document.getElementById('anki-answer');
      const divider = document.getElementById('anki-divider');
      const showBtn = document.getElementById('show-answer-btn');
      const ratingEl = document.getElementById('anki-rating');
      const label = document.getElementById('anki-label');
      const nameEl = document.getElementById('study-deck-name');
      const progText = document.getElementById('study-progress-text');
      const progFill = document.getElementById('study-progress-fill');

      nameEl.textContent = currentDeck;

      if (studyCards.length === 0) {
        qEl.textContent = 'カードがありません';
        aEl.style.display = 'none';
        divider.style.display = 'none';
        showBtn.style.display = 'none';
        ratingEl.style.display = 'none';
        progText.textContent = '0 / 0';
        progFill.style.width = '0%';
        label.textContent = '';
        return;
      }

      const card = studyCards[studyIndex];
      progText.textContent = `${studyIndex + 1} / ${studyCards.length}`;
      progFill.style.width = `${((studyIndex + 1) / studyCards.length) * 100}%`;

      qEl.textContent = card.question;
      aEl.textContent = card.answer;

      if (answerShown) {
        label.textContent = '問題 + 答え';
        aEl.style.display = 'block';
        divider.style.display = 'block';
        showBtn.style.display = 'none';
        ratingEl.style.display = 'flex';
      } else {
        label.textContent = '問題';
        aEl.style.display = 'none';
        divider.style.display = 'none';
        showBtn.style.display = 'block';
        ratingEl.style.display = 'none';
      }
    }

    // 答え表示
    document.getElementById('show-answer-btn').addEventListener('click', () => {
      answerShown = true;
      renderStudyCard();
    });
    document.getElementById('anki-card').addEventListener('click', () => {
      if (!answerShown && studyCards.length > 0) {
        answerShown = true;
        renderStudyCard();
      }
    });

    // 評価 → 次のカード
    document.querySelectorAll('.anki-rating-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const rating = btn.dataset.rating;
        stats.reviews++;
        stats[rating]++;
        S.save(S.K.STATS, stats);

        studyIndex = (studyIndex + 1) % studyCards.length;
        answerShown = false;
        renderStudyCard();
      });
    });

    // シャッフル
    document.getElementById('shuffle-btn').addEventListener('click', () => {
      for (let i = studyCards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [studyCards[i], studyCards[j]] = [studyCards[j], studyCards[i]];
      }
      studyIndex = 0;
      answerShown = false;
      renderStudyCard();
    });

    // 自動再生
    document.getElementById('autoplay-btn').addEventListener('click', () => {
      if (studyCards.length === 0) return;
      isPlaying = true;
      document.getElementById('autoplay-bar').classList.remove('hidden');
      document.getElementById('autoplay-btn').classList.add('active');
      autoPlayNext();
    });
    document.getElementById('autoplay-stop').addEventListener('click', stopAutoPlay);

    function stopAutoPlay() {
      isPlaying = false;
      if (playTimer) clearTimeout(playTimer);
      document.getElementById('autoplay-bar').classList.add('hidden');
      document.getElementById('autoplay-btn').classList.remove('active');
      document.getElementById('autoplay-status').textContent = '自動再生中...';
    }

    function autoPlayNext() {
      if (!isPlaying) return;
      const qDelay = parseInt(document.getElementById('cfg-q-delay').value) * 1000;
      const aDelay = parseInt(document.getElementById('cfg-a-delay').value) * 1000;

      answerShown = false;
      renderStudyCard();
      document.getElementById('autoplay-status').textContent = '問題を表示中...';

      playTimer = setTimeout(() => {
        if (!isPlaying) return;
        answerShown = true;
        renderStudyCard();
        document.getElementById('autoplay-status').textContent = '答えを表示中...';

        playTimer = setTimeout(() => {
          if (!isPlaying) return;
          stats.reviews++;
          stats.good++;
          S.save(S.K.STATS, stats);
          studyIndex = (studyIndex + 1) % studyCards.length;
          autoPlayNext();
        }, aDelay);
      }, qDelay);
    }

    /* ========== Manage ========== */
    function renderManageList() {
      const deckCards = cards.filter(c => c.deck === currentDeck);
      document.getElementById('manage-card-count').textContent = `カード (${deckCards.length}枚)`;

      const container = document.getElementById('manage-card-list');
      if (deckCards.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#x1f4dd;</div><p>カードがまだありません</p></div>';
        return;
      }

      container.innerHTML = deckCards.map(c => `
        <div class="card-item">
          <div class="card-item-content">
            <div class="card-item-q">${esc(c.question)}</div>
            <div class="card-item-a">${esc(c.answer)}</div>
          </div>
          <div class="card-item-actions">
            <button class="card-item-btn" data-action="edit" data-id="${c.id}">&#x270f;</button>
            <button class="card-item-btn" data-action="delete" data-id="${c.id}">&#x1f5d1;</button>
          </div>
        </div>
      `).join('');

      container.querySelectorAll('.card-item-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.dataset.action === 'edit') editCard(btn.dataset.id);
          if (btn.dataset.action === 'delete') deleteCard(btn.dataset.id);
        });
      });
    }

    // カードフォーム
    document.getElementById('card-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const q = document.getElementById('card-question').value.trim();
      const a = document.getElementById('card-answer').value.trim();
      if (!q || !a) return;

      if (editingId) {
        const idx = cards.findIndex(c => c.id === editingId);
        if (idx !== -1) cards[idx] = { ...cards[idx], question: q, answer: a };
        resetForm();
      } else {
        cards.push({ id: Date.now().toString(), question: q, answer: a, deck: currentDeck, created: new Date().toISOString() });
      }
      S.save(S.K.CARDS, cards);
      document.getElementById('card-question').value = '';
      document.getElementById('card-answer').value = '';
      renderManageList();
    });

    function editCard(id) {
      const card = cards.find(c => c.id === id);
      if (!card) return;
      editingId = id;
      document.getElementById('card-question').value = card.question;
      document.getElementById('card-answer').value = card.answer;
      document.getElementById('manage-form-title').textContent = 'カードを編集';
      document.getElementById('card-submit-btn').textContent = '更新';
      document.getElementById('card-cancel-btn').style.display = 'block';
      document.getElementById('card-question').scrollIntoView({ behavior: 'smooth' });
    }

    function deleteCard(id) {
      if (!confirm('このカードを削除しますか？')) return;
      cards = cards.filter(c => c.id !== id);
      S.save(S.K.CARDS, cards);
      renderManageList();
    }

    function resetForm() {
      editingId = null;
      document.getElementById('card-question').value = '';
      document.getElementById('card-answer').value = '';
      document.getElementById('manage-form-title').textContent = 'カードを追加';
      document.getElementById('card-submit-btn').textContent = '追加';
      document.getElementById('card-cancel-btn').style.display = 'none';
    }
    document.getElementById('card-cancel-btn').addEventListener('click', resetForm);

    /* ========== Stats ========== */
    function renderStats() {
      document.getElementById('s-total-cards').textContent = cards.length;
      document.getElementById('s-total-reviews').textContent = stats.reviews;
      document.getElementById('s-easy').textContent = stats.easy;
      document.getElementById('s-good').textContent = stats.good;
      document.getElementById('s-hard').textContent = stats.hard;
      document.getElementById('s-decks').textContent = decks.length;
    }
    document.getElementById('reset-stats-btn').addEventListener('click', () => {
      if (!confirm('統計をリセットしますか？')) return;
      stats = { reviews: 0, easy: 0, good: 0, hard: 0 };
      S.save(S.K.STATS, stats);
      renderStats();
    });

    /* ========== Settings Modal ========== */
    document.getElementById('settings-btn').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.add('active');
    });
    document.getElementById('settings-close').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('active');
    });
    document.getElementById('settings-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) document.getElementById('settings-modal').classList.remove('active');
    });

    /* ========== Header buttons ========== */
    document.getElementById('stats-btn').addEventListener('click', () => navigateTo('stats'));

    /* ========== Import / Export ========== */
    document.getElementById('export-btn').addEventListener('click', () => {
      const data = { cards, decks, stats, exportDate: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `flashcards_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
    document.getElementById('import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.cards) {
            const add = confirm('既存に追加しますか？\nOK=追加 / キャンセル=置き換え');
            if (add) cards = [...cards, ...data.cards.map(c => ({ ...c, id: Date.now().toString() + Math.random() }))];
            else cards = data.cards;
          }
          if (data.decks) decks = [...new Set([...decks, ...data.decks])];
          S.save(S.K.CARDS, cards);
          S.save(S.K.DECKS, decks);
          renderDeckList();
          alert('インポート完了！');
        } catch { alert('読み込みに失敗しました'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    /* ========== Util ========== */
    function esc(t) {
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }

    /* ========== Init ========== */
    renderDeckList();
  </script>
</body>
</html>
